<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>ZLayer · ZIO</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="A `ZLayer[-RIn, +E, +ROut]` describes a layer of an application: every layer in an application requires some services as input `RIn` and produces some services as the output `ROut`. "/><meta name="docsearch:language" content="en"/><meta property="og:title" content="ZLayer · ZIO"/><meta property="og:type" content="website"/><meta property="og:url" content="https://zio.dev/"/><meta property="og:description" content="A `ZLayer[-RIn, +E, +ROut]` describes a layer of an application: every layer in an application requires some services as input `RIn` and produces some services as the output `ROut`. "/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100,"cornerOffset":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/navbar_brand.png" alt="ZIO"/><h2 class="headerTitleWithLogo">ZIO</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/overview/overview_index" target="_self">Overview</a></li><li class="siteNavGroupActive"><a href="/docs/datatypes/" target="_self">Data Types</a></li><li class=""><a href="/docs/services/" target="_self">Services</a></li><li class=""><a href="/docs/usecases/usecases_index" target="_self">Use Cases</a></li><li class=""><a href="/docs/howto/" target="_self">How to</a></li><li class=""><a href="/docs/resources/" target="_self">Resources</a></li><li class=""><a href="/docs/about/about_index" target="_self">About</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Contextual Types</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Overview<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/datatypes/">Introduction</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Core Data Types<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/datatypes/core/">Summary</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/core/zio">ZIO</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/core/uio">UIO</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/core/urio">URIO</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/core/task">Task</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/core/rio">RIO</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/core/io">IO</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/core/exit">Exit</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/core/cause">Cause</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/core/runtime">Runtime</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Contextual Types<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/datatypes/contextual/">Introduction</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/contextual/has">Has</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/datatypes/contextual/zlayer">ZLayer</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/contextual/rlayer">RLayer</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/contextual/ulayer">ULayer</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/contextual/layer">Layer</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/contextual/urlayer">URLayer</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/contextual/tasklayer">TaskLayer</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Fiber Primitives<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/datatypes/fiber/">Summary</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/fiber/fiber">Fiber</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/fiber/fiberref">FiberRef</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/fiber/fiberid">Fiber.Id</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/fiber/fiberstatus">Fiber.Status</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Concurrency Primitives<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/datatypes/concurrency/">Introduction</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/concurrency/zref">ZRef</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/concurrency/ref">Ref</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/concurrency/zrefm">ZRefM</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/concurrency/refm">RefM</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/concurrency/promise">Promise</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/concurrency/queue">Queue</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/concurrency/hub">Hub</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/concurrency/semaphore">Semaphore</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">STM<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/datatypes/stm/">Introduction</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/stm/stm">STM</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/stm/tarray">TArray</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/stm/tset">TSet</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/stm/tmap">TMap</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/stm/tref">TRef</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/stm/tpriorityqueue">TPriorityQueue</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/stm/tpromise">TPromise</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/stm/tqueue">TQueue</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/stm/treentrantlock">TReentrantLock</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/stm/tsemaphore">TSemaphore</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Resource Safety<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/datatypes/resource/">Introduction</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/resource/zmanaged">ZManaged</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/resource/managed">Managed</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/resource/task-managed">TaskManaged</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/resource/rmanaged">RManaged</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/resource/umanaged">UManaged</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/resource/urmanaged">URManaged</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Streaming<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/datatypes/stream/">Summary</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/stream/stream">Stream</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/stream/sink">Sink</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/stream/subscription-ref">SubscriptionRef</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Miscellaneous<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/datatypes/misc/">Summary</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/misc/chunk">Chunk</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/misc/schedule">Schedule</a></li><li class="navListItem"><a class="navItem" href="/docs/datatypes/misc/supervisor">Supervisor</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/zio/zio/edit/master/docs/datatypes/contextual/zlayer.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 id="__docusaurus" class="postHeaderTitle">ZLayer</h1></header><article><div><span><p>A <code>ZLayer[-RIn, +E, +ROut]</code> describes a layer of an application: every layer in an application requires some services as input <code>RIn</code> and produces some services as the output <code>ROut</code>.</p>
<p>ZLayers are:</p>
<ol>
<li><p><strong>Recipes for Creating Services</strong> — They describe how a given dependencies produces another services. For example, the <code>ZLayer[Logging with Database, Throwable, UserRepo]</code> is a recipe for building a service that requires <code>Logging</code> and <code>Database</code> service, and it produces a <code>UserRepo</code> service.</p></li>
<li><p><strong>An Alternative to Constructors</strong> — We can think of <code>ZLayer</code> as a more powerful version of a constructor, it is an alternative way to represent a constructor. Like a constructor, it allows us to build the <code>ROut</code> service in terms of its dependencies (<code>RIn</code>).</p></li>
<li><p><strong>Composable</strong> — Because of their excellent <strong>composition properties</strong>, layers are the idiomatic way in ZIO to create services that depend on other services. We can define layers that are relying on each other.</p></li>
<li><p><strong>Effectful and Resourceful</strong> — The construction of ZIO layers can be effectful and resourceful, they can be acquired and safely released when the services are done being utilized.</p></li>
<li><p><strong>Asynchronous</strong> — Unlike class constructors which are blocking, ZLayer is fully asynchronous and non-blocking.</p></li>
</ol>
<p>For example, a <code>ZLayer[Blocking with Logging, Throwable, Database]</code> can be thought of as a function that map <code>Blocking</code> and <code>Logging</code> services into <code>Database</code> service:</p>
<pre><code class="hljs css language-scala">(<span class="hljs-type">Blocking</span>, <span class="hljs-type">Logging</span>) =&gt; <span class="hljs-type">Database</span>
</code></pre>
<p>So we can say that the <code>Database</code> service has two dependencies: <code>Blocking</code> and <code>Logging</code> services.</p>
<p>Let's see how we can create a layer:</p>
<h2><a class="anchor" aria-hidden="true" id="creation"></a><a href="#creation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Creation</h2>
<p><code>ZLayer</code> is an <strong>alternative to a class constructor</strong>, a recipe to create a service. This recipe may contain the following information:</p>
<ol>
<li><p><strong>Dependencies</strong> — To create a service, we need to indicate what other service we are depending on. For example, a <code>Database</code> service might need <code>Socket</code> and <code>Blocking</code> services to perform its operations.</p></li>
<li><p><strong>Acquisition/Release Action</strong> — It may contain how to initialize a service. For example, if we are creating a recipe for a <code>Database</code> service, we should provide how the <code>Database</code> will be initialized, via acquisition action. Also, it may contain how to release a service. For example, how the <code>Database</code> releases its connection pools.</p></li>
</ol>
<p>In some cases, a <code>ZLayer</code> may not have any dependencies or requirements from the environment. In this case, we can specify <code>Any</code> for the <code>RIn</code> type parameter. The <code>Layer</code> type alias provided by ZIO is a convenient way to define a layer without requirements.</p>
<p>There are many ways to create a ZLayer. Here's an incomplete list:</p>
<ul>
<li><code>ZLayer.succeed</code> to create a layer from an existing service</li>
<li><code>ZLayer.succeedMany</code> to create a layer from a value that's one or more services</li>
<li><code>ZLayer.fromFunction</code> to create a layer from a function from the requirement to the service</li>
<li><code>ZLayer.fromEffect</code> to lift a <code>ZIO</code> effect to a layer requiring the effect environment</li>
<li><code>ZLayer.fromAcquireRelease</code> for a layer based on resource acquisition/release. The idea is the same as <code>ZManaged</code>.</li>
<li><code>ZLayer.fromService</code> to build a layer from a service</li>
<li><code>ZLayer.fromServices</code> to build a layer from a number of required services</li>
<li><code>ZLayer.identity</code> to express the requirement for a layer</li>
<li><code>ZIO#toLayer</code> or <code>ZManaged#toLayer</code> to construct a layer from an effect</li>
</ul>
<p>Where it makes sense, these methods have also variants to build a service effectfully (suffixed by <code>M</code>), resourcefully (suffixed by <code>Managed</code>), or to create a combination of services (suffixed by <code>Many</code>).</p>
<p>Let's review some of the <code>ZLayer</code>'s most useful constructors:</p>
<h3><a class="anchor" aria-hidden="true" id="from-simple-values"></a><a href="#from-simple-values" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>From Simple Values</h3>
<p>With <code>ZLayer.succeed</code> we can construct a <code>ZLayer</code> from a value. It returns a <code>ULayer[Has[A]]</code> value, which represents a layer of application that <em>has</em> a service of type <code>A</code>:</p>
<pre><code class="hljs css language-scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">succeed</span></span>[<span class="hljs-type">A</span>: <span class="hljs-type">Tag</span>](a: <span class="hljs-type">A</span>): <span class="hljs-type">ULayer</span>[<span class="hljs-type">Has</span>[<span class="hljs-type">A</span>]]
</code></pre>
<p>In the following example, we are going to create a <code>nameLayer</code> that provides us the name of <code>Adam</code>.</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> nameLayer: <span class="hljs-type">ULayer</span>[<span class="hljs-type">Has</span>[<span class="hljs-type">String</span>]] = <span class="hljs-type">ZLayer</span>.succeed(<span class="hljs-string">"Adam"</span>)
</code></pre>
<p>In most cases, we use <code>ZLayer.succeed</code> to provide a layer of service of type <code>A</code>.</p>
<p>For example, assume we have written the following service:</p>
<pre><code class="hljs css language-scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">terminal</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Terminal</span> </span>= <span class="hljs-type">Has</span>[<span class="hljs-type">Terminal</span>.<span class="hljs-type">Service</span>]

  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Terminal</span> </span>{
    <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Service</span> </span>{
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">putStrLn</span></span>(line: <span class="hljs-type">String</span>): <span class="hljs-type">UIO</span>[<span class="hljs-type">Unit</span>]
    }

    <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Service</span> </span>{
      <span class="hljs-keyword">val</span> live: <span class="hljs-type">Service</span> = <span class="hljs-keyword">new</span> <span class="hljs-type">Service</span> {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">putStrLn</span></span>(line: <span class="hljs-type">String</span>): <span class="hljs-type">UIO</span>[<span class="hljs-type">Unit</span>] =
          <span class="hljs-type">ZIO</span>.effectTotal(println(line))
      }
    }
  }
}
</code></pre>
<p>Now we can create a <code>ZLayer</code> from the <code>live</code> version of this service:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> terminal._
<span class="hljs-keyword">val</span> live: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Terminal</span>] = <span class="hljs-type">ZLayer</span>.succeed(<span class="hljs-type">Terminal</span>.<span class="hljs-type">Service</span>.live)
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="from-managed-resources"></a><a href="#from-managed-resources" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>From Managed Resources</h3>
<p>Some components of our applications need to be managed, meaning they undergo a resource acquisition phase before usage, and a resource release phase after usage (e.g. when the application shuts down).</p>
<p>Fortunately, the construction of ZIO layers can be effectful and resourceful, this means they can be acquired and safely released when the services are done being utilized.</p>
<p><code>ZLayer</code> relies on the powerful <code>ZManaged</code> data type and this makes this process extremely simple.</p>
<p>We can lift any <code>ZManaged</code> to <code>ZLayer</code> by providing a managed resource to the <code>ZIO.fromManaged</code> constructor:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> managedFile = <span class="hljs-type">ZManaged</span>.fromAutoCloseable(
  <span class="hljs-type">ZIO</span>.effect(scala.io.<span class="hljs-type">Source</span>.fromFile(<span class="hljs-string">"file.txt"</span>))
)
<span class="hljs-keyword">val</span> fileLayer: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Throwable</span>, <span class="hljs-type">Has</span>[<span class="hljs-type">BufferedSource</span>]] = 
  <span class="hljs-type">ZLayer</span>.fromManaged(managedFile)
</code></pre>
<p>Also, every <code>ZManaged</code> can be converted to <code>ZLayer</code> by calling <code>ZLayer#toLayer</code>:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> fileLayer: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Throwable</span>, <span class="hljs-type">Has</span>[<span class="hljs-type">BufferedSource</span>]] = managedFile.toLayer
</code></pre>
<p>Let's see another real-world example of creating a layer from managed resources. Assume we have written a managed <code>UserRepository</code>:</p>
<pre><code class="hljs css language-scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">userRepository</span></span>: <span class="hljs-type">ZManaged</span>[<span class="hljs-type">Blocking</span> <span class="hljs-keyword">with</span> <span class="hljs-type">Console</span>, <span class="hljs-type">Throwable</span>, <span class="hljs-type">UserRepository</span>] = <span class="hljs-keyword">for</span> {
  cfg &lt;- dbConfig.toManaged_
  _ &lt;- initializeDb(cfg).toManaged_
  xa &lt;- makeTransactor(cfg)
} <span class="hljs-keyword">yield</span> <span class="hljs-keyword">new</span> <span class="hljs-type">UserRepository</span>(xa)
</code></pre>
<p>We can convert that to <code>ZLayer</code> with <code>ZLayer.fromManaged</code> or <code>ZManaged#toLayer</code>:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> usersLayer  = userRepository.toLayer
<span class="hljs-comment">// usersLayer: ZLayer[Blocking with Console, Throwable, Has[UserRepository]] = Managed(</span>
<span class="hljs-comment">//   self = zio.ZManaged$$anon$2@1236d42f</span>
<span class="hljs-comment">// )</span>
<span class="hljs-keyword">val</span> usersLayer_ = <span class="hljs-type">ZLayer</span>.fromManaged(userRepository)
<span class="hljs-comment">// usersLayer_: ZLayer[Blocking with Console, Throwable, Has[UserRepository]] = Managed(</span>
<span class="hljs-comment">//   self = zio.ZManaged$$anon$2@f2f617</span>
<span class="hljs-comment">// )</span>
</code></pre>
<p>Also, we can create a <code>ZLayer</code> directly from <code>acquire</code> and <code>release</code> actions of a managed resource:</p>
<pre><code class="hljs css language-scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">acquire</span> </span>= <span class="hljs-type">ZIO</span>.effect(<span class="hljs-keyword">new</span> <span class="hljs-type">FileInputStream</span>(<span class="hljs-string">"file.txt"</span>))
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">release</span></span>(resource: <span class="hljs-type">Closeable</span>) = <span class="hljs-type">ZIO</span>.effectTotal(resource.close())

<span class="hljs-keyword">val</span> inputStreamLayer = <span class="hljs-type">ZLayer</span>.fromAcquireRelease(acquire)(release)
<span class="hljs-comment">// inputStreamLayer: ZLayer[Any, Throwable, Has[FileInputStream]] = Managed(</span>
<span class="hljs-comment">//   self = zio.ZManaged$$anon$2@6e349190</span>
<span class="hljs-comment">// )</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="from-zio-effects"></a><a href="#from-zio-effects" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>From ZIO Effects</h3>
<p>We can create <code>ZLayer</code> from any <code>ZIO</code> effect by using <code>ZLayer.fromEffect</code> constructor, or calling <code>ZIO#toLayer</code> method:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> layer = <span class="hljs-type">ZLayer</span>.fromEffect(<span class="hljs-type">ZIO</span>.succeed(<span class="hljs-string">"Hello, World!"</span>))
<span class="hljs-comment">// layer: ZLayer[Any, Nothing, Has[String]] = Managed(</span>
<span class="hljs-comment">//   self = zio.ZManaged$$anon$2@3c9ad1f2</span>
<span class="hljs-comment">// )</span>
<span class="hljs-keyword">val</span> layer_ = <span class="hljs-type">ZIO</span>.succeed(<span class="hljs-string">"Hello, World!"</span>).toLayer
<span class="hljs-comment">// layer_: ZLayer[Any, Nothing, Has[String]] = Managed(</span>
<span class="hljs-comment">//   self = zio.ZManaged$$anon$2@302ea758</span>
<span class="hljs-comment">// )</span>
</code></pre>
<p>Assume we have a <code>ZIO</code> effect that read the application config from a file, we can create a layer from that:</p>
<pre><code class="hljs css language-scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">loadConfig</span></span>: <span class="hljs-type">Task</span>[<span class="hljs-type">AppConfig</span>] = <span class="hljs-type">Task</span>.effect(???)
<span class="hljs-keyword">val</span> configLayer = <span class="hljs-type">ZLayer</span>.fromEffect(loadConfig)
<span class="hljs-comment">// configLayer: ZLayer[Any, Throwable, Has[AppConfig]] = Managed(</span>
<span class="hljs-comment">//   self = zio.ZManaged$$anon$2@30457d5</span>
<span class="hljs-comment">// )</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="from-another-service"></a><a href="#from-another-service" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>From another Service</h3>
<p>Every <code>ZLayer</code> describes an application that requires some services as input and produces some services as output. Sometimes when we are writing a new layer, we may need to access and depend on one or several services.</p>
<p>The <code>ZLayer.fromService</code> construct a layer that purely depends on the specified service:</p>
<pre><code class="hljs css language-scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fromService</span></span>[<span class="hljs-type">A</span>: <span class="hljs-type">Tag</span>, <span class="hljs-type">B</span>: <span class="hljs-type">Tag</span>](f: <span class="hljs-type">A</span> =&gt; <span class="hljs-type">B</span>): <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Has</span>[<span class="hljs-type">A</span>], <span class="hljs-type">Nothing</span>, <span class="hljs-type">Has</span>[<span class="hljs-type">B</span>]]
</code></pre>
<p>Assume we want to write a <code>live</code> version of the following logging service:</p>
<pre><code class="hljs css language-scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">logging</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Logging</span> </span>= <span class="hljs-type">Has</span>[<span class="hljs-type">Logging</span>.<span class="hljs-type">Service</span>]

  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Logging</span> </span>{
    <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Service</span> </span>{
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">log</span></span>(msg: <span class="hljs-type">String</span>): <span class="hljs-type">UIO</span>[<span class="hljs-type">Unit</span>]
    }
  }
}
</code></pre>
<p>We can create that by using <code>ZLayer.fromService</code> constructor, which depends on <code>Console</code> service:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> live: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Console</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Logging</span>] = <span class="hljs-type">ZLayer</span>.fromService(console =&gt;
  <span class="hljs-keyword">new</span> <span class="hljs-type">Service</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">log</span></span>(msg: <span class="hljs-type">String</span>): <span class="hljs-type">UIO</span>[<span class="hljs-type">Unit</span>] = console.putStrLn(msg).orDie
  }
)
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="vertical-and-horizontal-composition"></a><a href="#vertical-and-horizontal-composition" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Vertical and Horizontal Composition</h2>
<p>We said that we can think of the <code>ZLayer</code> as a more powerful <em>constructor</em>. Constructors are not composable, because they are not values. While a constructor is not composable, <code>ZLayer</code> has a nice facility to compose with other <code>ZLayer</code>s. So we can say that a <code>Zlayer</code> turns a constructor into values.</p>
<p><code>ZLayer</code>s can be composed together horizontally or vertically:</p>
<ol>
<li><p><strong>Horizontal Composition</strong> — They can be composed together horizontally with the <code>++</code> operator. When we compose two layers horizontally, the new layer that this layer requires all the services that both of them require, also this layer produces all services that both of them produces. Horizontal composition is a way of composing two layers side-by-side. It is useful when we combine two layers that they don't have any relationship with each other.</p></li>
<li><p><strong>Vertical Composition</strong> — If we have a layer that requires <code>A</code> and produces <code>B</code>, we can compose this layer with another layer that requires <code>B</code> and produces <code>C</code>; this composition produces a layer that requires <code>A</code> and produces <code>C</code>. The feed operator, <code>&gt;&gt;&gt;</code>, stack them on top of each other by using vertical composition. This sort of composition is like <em>function composition</em>, feeding an output of one layer to an input of another.</p></li>
</ol>
<p>Let's get into an example, assume we have these services with their implementations:</p>
<pre><code class="hljs css language-scala"><span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Logging</span> </span>{ }
<span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Database</span> </span>{ }
<span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">BlobStorage</span> </span>{ }
<span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">UserRepo</span> </span>{ }
<span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">DocRepo</span> </span>{ }

<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoggerImpl</span>(<span class="hljs-params">console: <span class="hljs-type">Console</span>.<span class="hljs-type">Service</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">Logging</span> </span>{ }
<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseImp</span>(<span class="hljs-params">blocking: <span class="hljs-type">Blocking</span>.<span class="hljs-type">Service</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">Database</span> </span>{ }
<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRepoImpl</span>(<span class="hljs-params">logging: <span class="hljs-type">Logging</span>, database: <span class="hljs-type">Database</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">UserRepo</span> </span>{ } 
<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlobStorageImpl</span>(<span class="hljs-params">logging: <span class="hljs-type">Logging</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">BlobStorage</span> </span>{ }
<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocRepoImpl</span>(<span class="hljs-params">logging: <span class="hljs-type">Logging</span>, database: <span class="hljs-type">Database</span>, blobStorage: <span class="hljs-type">BlobStorage</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">DocRepo</span> </span>{ }
</code></pre>
<p>We can't compose these services together, because their constructors are not value. <code>ZLayer</code> can convert these services into values, then we can compose them together.</p>
<p>Let's assume we have lifted these services into <code>ZLayer</code>s:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> logging: <span class="hljs-type">URLayer</span>[<span class="hljs-type">Has</span>[<span class="hljs-type">Console</span>.<span class="hljs-type">Service</span>], <span class="hljs-type">Has</span>[<span class="hljs-type">Logging</span>]] = 
  (<span class="hljs-type">LoggerImpl</span>.apply _).toLayer
<span class="hljs-keyword">val</span> database: <span class="hljs-type">URLayer</span>[<span class="hljs-type">Has</span>[<span class="hljs-type">Blocking</span>.<span class="hljs-type">Service</span>], <span class="hljs-type">Has</span>[<span class="hljs-type">Database</span>]] = 
  (<span class="hljs-type">DatabaseImp</span>(_)).toLayer
<span class="hljs-keyword">val</span> userRepo: <span class="hljs-type">URLayer</span>[<span class="hljs-type">Has</span>[<span class="hljs-type">Logging</span>] <span class="hljs-keyword">with</span> <span class="hljs-type">Has</span>[<span class="hljs-type">Database</span>], <span class="hljs-type">Has</span>[<span class="hljs-type">UserRepo</span>]] = 
  (<span class="hljs-type">UserRepoImpl</span>(_, _)).toLayer
<span class="hljs-keyword">val</span> blobStorage: <span class="hljs-type">URLayer</span>[<span class="hljs-type">Has</span>[<span class="hljs-type">Logging</span>], <span class="hljs-type">Has</span>[<span class="hljs-type">BlobStorage</span>]] = 
  (<span class="hljs-type">BlobStorageImpl</span>(_)).toLayer
<span class="hljs-keyword">val</span> docRepo: <span class="hljs-type">URLayer</span>[<span class="hljs-type">Has</span>[<span class="hljs-type">Logging</span>] <span class="hljs-keyword">with</span> <span class="hljs-type">Has</span>[<span class="hljs-type">Database</span>] <span class="hljs-keyword">with</span> <span class="hljs-type">Has</span>[<span class="hljs-type">BlobStorage</span>], <span class="hljs-type">Has</span>[<span class="hljs-type">DocRepo</span>]] = 
  (<span class="hljs-type">DocRepoImpl</span>(_, _, _)).toLayer
</code></pre>
<p>Now, we can compose logging and database horizontally:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> newLayer: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Has</span>[<span class="hljs-type">Console</span>.<span class="hljs-type">Service</span>] <span class="hljs-keyword">with</span> <span class="hljs-type">Has</span>[<span class="hljs-type">Blocking</span>.<span class="hljs-type">Service</span>], <span class="hljs-type">Throwable</span>, <span class="hljs-type">Has</span>[<span class="hljs-type">Logging</span>] <span class="hljs-keyword">with</span> <span class="hljs-type">Has</span>[<span class="hljs-type">Database</span>]] = logging ++ database
</code></pre>
<p>And then we can compose the <code>newLayer</code> with <code>userRepo</code> vertically:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> myLayer: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Has</span>[<span class="hljs-type">Console</span>.<span class="hljs-type">Service</span>] <span class="hljs-keyword">with</span> <span class="hljs-type">Has</span>[<span class="hljs-type">Blocking</span>.<span class="hljs-type">Service</span>], <span class="hljs-type">Throwable</span>, <span class="hljs-type">Has</span>[<span class="hljs-type">UserRepo</span>]] = newLayer &gt;&gt;&gt; userRepo
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="layer-memoization"></a><a href="#layer-memoization" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Layer Memoization</h2>
<p>One important feature of <code>ZIO</code> layers is that <strong>they are shared by default</strong>, meaning that if the same layer is used twice, the layer will only be allocated a single time.</p>
<p>For every layer in our dependency graph, there is only one instance of it that is shared between all the layers that depend on it.</p>
<p>If we don't want to share a module, we should create a fresh, non-shared version of it through <code>ZLayer#fresh</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="updating-local-dependencies"></a><a href="#updating-local-dependencies" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Updating Local Dependencies</h2>
<p>Given a layer, it is possible to update one or more components it provides. We update a dependency in two ways:</p>
<ol>
<li><strong>Using the <code>update</code> Method</strong> — This method allows us to replace one requirement with a different implementation:</li>
</ol>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> withPostgresService = horizontal.update[<span class="hljs-type">UserRepo</span>.<span class="hljs-type">Service</span>]{ oldRepo  =&gt; <span class="hljs-keyword">new</span> <span class="hljs-type">UserRepo</span>.<span class="hljs-type">Service</span> {
      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getUser</span></span>(userId: <span class="hljs-type">UserId</span>): <span class="hljs-type">IO</span>[<span class="hljs-type">DBError</span>, <span class="hljs-type">Option</span>[<span class="hljs-type">User</span>]] = <span class="hljs-type">UIO</span>(???)
      <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">createUser</span></span>(user: <span class="hljs-type">User</span>): <span class="hljs-type">IO</span>[<span class="hljs-type">DBError</span>, <span class="hljs-type">Unit</span>] = <span class="hljs-type">UIO</span>(???)
    }
  }
</code></pre>
<ol start="2">
<li><strong>Using Horizontal Composition</strong> — Another way to update a requirement is to horizontally compose in a layer that provides the updated service. The resulting composition will replace the old layer with the new one:</li>
</ol>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> dbLayer: <span class="hljs-type">Layer</span>[<span class="hljs-type">Nothing</span>, <span class="hljs-type">UserRepo</span>] = <span class="hljs-type">ZLayer</span>.succeed(<span class="hljs-keyword">new</span> <span class="hljs-type">UserRepo</span>.<span class="hljs-type">Service</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getUser</span></span>(userId: <span class="hljs-type">UserId</span>): <span class="hljs-type">IO</span>[<span class="hljs-type">DBError</span>, <span class="hljs-type">Option</span>[<span class="hljs-type">User</span>]] = ???
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">createUser</span></span>(user: <span class="hljs-type">User</span>): <span class="hljs-type">IO</span>[<span class="hljs-type">DBError</span>, <span class="hljs-type">Unit</span>] = ???
  })

<span class="hljs-keyword">val</span> updatedHorizontal2 = horizontal ++ dbLayer
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="hidden-versus-passed-through-dependencies"></a><a href="#hidden-versus-passed-through-dependencies" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hidden Versus Passed Through Dependencies</h2>
<p>One design decision regarding building dependency graphs is whether to hide or pass through the upstream dependencies of a service. <code>ZLayer</code> defaults to hidden dependencies but makes it easy to pass through dependencies as well.</p>
<p>To illustrate this, consider the Postgres-based repository discussed above:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> connection: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Has</span>[<span class="hljs-type">Connection</span>]] = connectionLayer
<span class="hljs-keyword">val</span> userRepo: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Has</span>[<span class="hljs-type">Connection</span>], <span class="hljs-type">Nothing</span>, <span class="hljs-type">UserRepo</span>] = postgresLayer
<span class="hljs-keyword">val</span> layer: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">UserRepo</span>] = connection &gt;&gt;&gt; userRepo
</code></pre>
<p>Notice that in <code>layer</code>, the dependency <code>UserRepo</code> has on <code>Connection</code> has been &quot;hidden&quot;, and is no longer expressed in the type signature. From the perspective of a caller, <code>layer</code> just outputs a <code>UserRepo</code> and requires no inputs. The caller does not need to be concerned with the internal implementation details of how the <code>UserRepo</code> is constructed.</p>
<p>To provide only some inputs, we need to explicitly define what inputs still need to be provided:</p>
<pre><code class="hljs css language-scala"><span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Configuration</span></span>

<span class="hljs-keyword">val</span> userRepoWithConfig: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Has</span>[<span class="hljs-type">Configuration</span>] <span class="hljs-keyword">with</span> <span class="hljs-type">Has</span>[<span class="hljs-type">Connection</span>], <span class="hljs-type">Nothing</span>, <span class="hljs-type">UserRepo</span>] = 
  <span class="hljs-type">ZLayer</span>.succeed(<span class="hljs-keyword">new</span> <span class="hljs-type">Configuration</span>{}) ++ postgresLayer
<span class="hljs-keyword">val</span> partialLayer: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Has</span>[<span class="hljs-type">Configuration</span>], <span class="hljs-type">Nothing</span>, <span class="hljs-type">UserRepo</span>] = 
  (<span class="hljs-type">ZLayer</span>.identity[<span class="hljs-type">Has</span>[<span class="hljs-type">Configuration</span>]] ++ connection) &gt;&gt;&gt; userRepoWithConfig
</code></pre>
<p>In this example the requirement for a <code>Connection</code> has been satisfied, but <code>Configuration</code> is still required by <code>partialLayer</code>.</p>
<p>This achieves an encapsulation of services and can make it easier to refactor code. For example, say we want to refactor our application to use an in-memory database:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> updatedLayer: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">UserRepo</span>] = dbLayer
</code></pre>
<p>No other code will need to be changed, because the previous implementation's dependency upon a <code>Connection</code> was hidden from users, and so they were not able to rely on it.</p>
<p>However, if an upstream dependency is used by many other services, it can be convenient to &quot;pass through&quot; that dependency, and include it in the output of a layer. This can be done with the <code>&gt;+&gt;</code> operator, which provides the output of one layer to another layer, returning a new layer that outputs the services of <em>both</em> layers.</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">val</span> layer: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Has</span>[<span class="hljs-type">Connection</span>] <span class="hljs-keyword">with</span> <span class="hljs-type">UserRepo</span>] = connection &gt;+&gt; userRepo
</code></pre>
<p>Here, the <code>Connection</code> dependency has been passed through, and is available to all downstream services. This allows a style of composition where the <code>&gt;+&gt;</code> operator is used to build a progressively larger set of services, with each new service able to depend on all the services before it.</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">lazy</span> <span class="hljs-keyword">val</span> baker: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Baker</span>] = ???
<span class="hljs-keyword">lazy</span> <span class="hljs-keyword">val</span> ingredients: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Ingredients</span>] = ???
<span class="hljs-keyword">lazy</span> <span class="hljs-keyword">val</span> oven: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Oven</span>] = ???
<span class="hljs-keyword">lazy</span> <span class="hljs-keyword">val</span> dough: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Baker</span> <span class="hljs-keyword">with</span> <span class="hljs-type">Ingredients</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Dough</span>] = ???
<span class="hljs-keyword">lazy</span> <span class="hljs-keyword">val</span> cake: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Baker</span> <span class="hljs-keyword">with</span> <span class="hljs-type">Oven</span> <span class="hljs-keyword">with</span> <span class="hljs-type">Dough</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Cake</span>] = ???

<span class="hljs-keyword">lazy</span> <span class="hljs-keyword">val</span> all: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Baker</span> <span class="hljs-keyword">with</span> <span class="hljs-type">Ingredients</span> <span class="hljs-keyword">with</span> <span class="hljs-type">Oven</span> <span class="hljs-keyword">with</span> <span class="hljs-type">Dough</span> <span class="hljs-keyword">with</span> <span class="hljs-type">Cake</span>] =
  baker &gt;+&gt;       <span class="hljs-comment">// Baker</span>
  ingredients &gt;+&gt; <span class="hljs-comment">// Baker with Ingredients</span>
  oven &gt;+&gt;        <span class="hljs-comment">// Baker with Ingredients with Oven</span>
  dough &gt;+&gt;       <span class="hljs-comment">// Baker with Ingredients with Oven with Dough</span>
  cake            <span class="hljs-comment">// Baker with Ingredients with Oven with Dough with Cake</span>
</code></pre>
<p><code>ZLayer</code> makes it easy to mix and match these styles. If you pass through dependencies and later want to hide them you can do so through a simple type ascription:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">lazy</span> <span class="hljs-keyword">val</span> hidden: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Cake</span>] = all
</code></pre>
<p>And if you do build your dependency graph more explicitly, you can be confident that layers used in multiple parts of the dependency graph will only be created once due to memoization and sharing.</p>
<h2><a class="anchor" aria-hidden="true" id="cyclic-dependencies"></a><a href="#cyclic-dependencies" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cyclic Dependencies</h2>
<p>The <code>ZLayer</code> mechanism makes it impossible to build cyclic dependencies, making the initialization process very linear, by construction.</p>
<h2><a class="anchor" aria-hidden="true" id="asynchronous-service-construction"></a><a href="#asynchronous-service-construction" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Asynchronous Service Construction</h2>
<p>Another important note about <code>ZLayer</code> is that, unlike constructors which are synchronous, <code>ZLayer</code> is <em>asynchronous</em>. Constructors in classes are always synchronous. This is a drawback for non-blocking applications. Because sometimes we might want to use something that is blocking the inside constructor.</p>
<p>For example, when we are constructing some sort of Kafka streaming service, we might want to connect to the Kafka cluster in the constructor of our service, which takes some time. So that wouldn't be a good idea to blocking inside a constructor. There are some workarounds for fixing this issue, but they are not perfect as the ZIO solution.</p>
<p>Well, with ZIO ZLayer, our constructor could be asynchronous, and they also can block definitely. And that is because <code>ZLayer</code> has the full power of ZIO. And as a result, we have strictly more power on our constructors with ZLayer.</p>
<p>We can acquire resources asynchronously or in a blocking fashion, and spend some time doing that, and we don't need to worry about it. That is not an anti-pattern. This is the best practice with ZIO.</p>
<h2><a class="anchor" aria-hidden="true" id="examples"></a><a href="#examples" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Examples</h2>
<h3><a class="anchor" aria-hidden="true" id="the-simplest-zlayer-application"></a><a href="#the-simplest-zlayer-application" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The simplest ZLayer application</h3>
<p>This application demonstrates a ZIO program with a single dependency on a simple string value:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> zio._

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Example</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">zio</span>.<span class="hljs-title">App</span> </span>{

  <span class="hljs-comment">// Define our simple ZIO program</span>
  <span class="hljs-keyword">val</span> zio: <span class="hljs-type">ZIO</span>[<span class="hljs-type">Has</span>[<span class="hljs-type">String</span>], <span class="hljs-type">Nothing</span>, <span class="hljs-type">Unit</span>] = <span class="hljs-keyword">for</span> {
    name &lt;- <span class="hljs-type">ZIO</span>.access[<span class="hljs-type">Has</span>[<span class="hljs-type">String</span>]](_.get)
    _    &lt;- <span class="hljs-type">UIO</span>(println(<span class="hljs-string">s"Hello, <span class="hljs-subst">$name</span>!"</span>))
  } <span class="hljs-keyword">yield</span> ()

  <span class="hljs-comment">// Create a ZLayer that produces a string and can be used to satisfy a string</span>
  <span class="hljs-comment">// dependency that the program has</span>
  <span class="hljs-keyword">val</span> nameLayer: <span class="hljs-type">ULayer</span>[<span class="hljs-type">Has</span>[<span class="hljs-type">String</span>]] = <span class="hljs-type">ZLayer</span>.succeed(<span class="hljs-string">"Adam"</span>)

  <span class="hljs-comment">// Run the program, providing the `nameLayer`</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span></span>(args: <span class="hljs-type">List</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">URIO</span>[<span class="hljs-type">ZEnv</span>, <span class="hljs-type">ExitCode</span>] =
    zio.provideLayer(nameLayer).as(<span class="hljs-type">ExitCode</span>.success)
}

</code></pre>
<h3><a class="anchor" aria-hidden="true" id="zlayer-application-with-dependencies"></a><a href="#zlayer-application-with-dependencies" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ZLayer application with dependencies</h3>
<p>In the following example, our ZIO application has several dependencies:</p>
<ul>
<li><code>zio.clock.Clock</code></li>
<li><code>zio.console.Console</code></li>
<li><code>ModuleB</code></li>
</ul>
<p><code>ModuleB</code> in turn depends upon <code>ModuleA</code>:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> zio._
<span class="hljs-keyword">import</span> zio.clock._
<span class="hljs-keyword">import</span> zio.console._
<span class="hljs-keyword">import</span> zio.duration.<span class="hljs-type">Duration</span>._
<span class="hljs-keyword">import</span> java.io.<span class="hljs-type">IOException</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">moduleA</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">ModuleA</span> </span>= <span class="hljs-type">Has</span>[<span class="hljs-type">ModuleA</span>.<span class="hljs-type">Service</span>]

  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">ModuleA</span> </span>{
    <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Service</span> </span>{
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">letsGoA</span></span>(v: <span class="hljs-type">Int</span>): <span class="hljs-type">UIO</span>[<span class="hljs-type">String</span>]
    }

    <span class="hljs-keyword">val</span> any: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">ModuleA</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">ModuleA</span>] =
      <span class="hljs-type">ZLayer</span>.requires[<span class="hljs-type">ModuleA</span>]

    <span class="hljs-keyword">val</span> live: <span class="hljs-type">Layer</span>[<span class="hljs-type">Nothing</span>, <span class="hljs-type">Has</span>[<span class="hljs-type">Service</span>]] = <span class="hljs-type">ZLayer</span>.succeed {
      <span class="hljs-keyword">new</span> <span class="hljs-type">Service</span> {
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">letsGoA</span></span>(v: <span class="hljs-type">Int</span>): <span class="hljs-type">UIO</span>[<span class="hljs-type">String</span>] = <span class="hljs-type">UIO</span>(<span class="hljs-string">s"done: v = <span class="hljs-subst">$v</span> "</span>)
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">letsGoA</span></span>(v: <span class="hljs-type">Int</span>): <span class="hljs-type">URIO</span>[<span class="hljs-type">ModuleA</span>, <span class="hljs-type">String</span>] =
    <span class="hljs-type">ZIO</span>.accessM(_.get.letsGoA(v))
}

<span class="hljs-keyword">import</span> moduleA._

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">moduleB</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">ModuleB</span> </span>= <span class="hljs-type">Has</span>[<span class="hljs-type">ModuleB</span>.<span class="hljs-type">Service</span>]

  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">ModuleB</span> </span>{
    <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Service</span> </span>{
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">letsGoB</span></span>(v: <span class="hljs-type">Int</span>): <span class="hljs-type">UIO</span>[<span class="hljs-type">String</span>]
    }

    <span class="hljs-keyword">val</span> any: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">ModuleB</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">ModuleB</span>] =
      <span class="hljs-type">ZLayer</span>.requires[<span class="hljs-type">ModuleB</span>]

    <span class="hljs-keyword">val</span> live: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">ModuleA</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">ModuleB</span>] = <span class="hljs-type">ZLayer</span>.fromService { (moduleA: <span class="hljs-type">ModuleA</span>.<span class="hljs-type">Service</span>) =&gt;
      <span class="hljs-keyword">new</span> <span class="hljs-type">Service</span> {
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">letsGoB</span></span>(v: <span class="hljs-type">Int</span>): <span class="hljs-type">UIO</span>[<span class="hljs-type">String</span>] =
          moduleA.letsGoA(v)
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">letsGoB</span></span>(v: <span class="hljs-type">Int</span>): <span class="hljs-type">URIO</span>[<span class="hljs-type">ModuleB</span>, <span class="hljs-type">String</span>] =
    <span class="hljs-type">ZIO</span>.accessM(_.get.letsGoB(v))
}

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">ZLayerApp0</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">zio</span>.<span class="hljs-title">App</span> </span>{

  <span class="hljs-keyword">import</span> moduleB._

  <span class="hljs-keyword">val</span> env = <span class="hljs-type">Console</span>.live ++ <span class="hljs-type">Clock</span>.live ++ (<span class="hljs-type">ModuleA</span>.live &gt;&gt;&gt; <span class="hljs-type">ModuleB</span>.live)
  <span class="hljs-keyword">val</span> program: <span class="hljs-type">ZIO</span>[<span class="hljs-type">Console</span> <span class="hljs-keyword">with</span> <span class="hljs-type">Clock</span> <span class="hljs-keyword">with</span> moduleB.<span class="hljs-type">ModuleB</span>, <span class="hljs-type">IOException</span>, <span class="hljs-type">Unit</span>] =
    <span class="hljs-keyword">for</span> {
      _ &lt;- putStrLn(<span class="hljs-string">s"Welcome to ZIO!"</span>)
      _ &lt;- sleep(<span class="hljs-type">Finite</span>(<span class="hljs-number">1000</span>))
      r &lt;- letsGoB(<span class="hljs-number">10</span>)
      _ &lt;- putStrLn(r)
    } <span class="hljs-keyword">yield</span> ()

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span></span>(args: <span class="hljs-type">List</span>[<span class="hljs-type">String</span>]) =
    program.provideLayer(env).exitCode

}

<span class="hljs-comment">// output: </span>
<span class="hljs-comment">// [info] running ZLayersApp </span>
<span class="hljs-comment">// Welcome to ZIO!</span>
<span class="hljs-comment">// done: v = 10 </span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="zlayer-example-with-complex-dependencies"></a><a href="#zlayer-example-with-complex-dependencies" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ZLayer example with complex dependencies</h3>
<p>In this example, we can see that <code>ModuleC</code> depends upon <code>ModuleA</code>, <code>ModuleB</code>, and <code>Clock</code>. The layer provided to the runnable application shows how dependency layers can be combined using <code>++</code> into a single combined layer. The combined layer will then be able to produce both of the outputs of the original layers as a single layer:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> zio._
<span class="hljs-keyword">import</span> zio.clock._

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">ZLayerApp1</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">scala</span>.<span class="hljs-title">App</span> </span>{
  <span class="hljs-keyword">val</span> rt = <span class="hljs-type">Runtime</span>.<span class="hljs-keyword">default</span>

  <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">ModuleA</span> </span>= <span class="hljs-type">Has</span>[<span class="hljs-type">ModuleA</span>.<span class="hljs-type">Service</span>]

  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">ModuleA</span> </span>{

    <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Service</span> </span>{}

    <span class="hljs-keyword">val</span> any: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">ModuleA</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">ModuleA</span>] =
      <span class="hljs-type">ZLayer</span>.requires[<span class="hljs-type">ModuleA</span>]

    <span class="hljs-keyword">val</span> live: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">ModuleA</span>] =
      <span class="hljs-type">ZLayer</span>.succeed(<span class="hljs-keyword">new</span> <span class="hljs-type">Service</span> {})
  }

  <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">ModuleB</span> </span>= <span class="hljs-type">Has</span>[<span class="hljs-type">ModuleB</span>.<span class="hljs-type">Service</span>]

  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">ModuleB</span> </span>{

    <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Service</span> </span>{}

    <span class="hljs-keyword">val</span> any: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">ModuleB</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">ModuleB</span>] =
      <span class="hljs-type">ZLayer</span>.requires[<span class="hljs-type">ModuleB</span>]

    <span class="hljs-keyword">val</span> live: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">Any</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">ModuleB</span>] =
      <span class="hljs-type">ZLayer</span>.succeed(<span class="hljs-keyword">new</span> <span class="hljs-type">Service</span> {})
  }

  <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">ModuleC</span> </span>= <span class="hljs-type">Has</span>[<span class="hljs-type">ModuleC</span>.<span class="hljs-type">Service</span>]

  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">ModuleC</span> </span>{

    <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Service</span> </span>{
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span></span>: <span class="hljs-type">UIO</span>[<span class="hljs-type">Int</span>]
    }

    <span class="hljs-keyword">val</span> any: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">ModuleC</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">ModuleC</span>] =
      <span class="hljs-type">ZLayer</span>.requires[<span class="hljs-type">ModuleC</span>]

    <span class="hljs-keyword">val</span> live: <span class="hljs-type">ZLayer</span>[<span class="hljs-type">ModuleA</span> <span class="hljs-keyword">with</span> <span class="hljs-type">ModuleB</span> <span class="hljs-keyword">with</span> <span class="hljs-type">Clock</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">ModuleC</span>] =
      <span class="hljs-type">ZLayer</span>.succeed {
        <span class="hljs-keyword">new</span> <span class="hljs-type">Service</span> {
          <span class="hljs-keyword">val</span> foo: <span class="hljs-type">UIO</span>[<span class="hljs-type">Int</span>] = <span class="hljs-type">UIO</span>.succeed(<span class="hljs-number">42</span>)
        }
      }

    <span class="hljs-keyword">val</span> foo: <span class="hljs-type">URIO</span>[<span class="hljs-type">ModuleC</span>, <span class="hljs-type">Int</span>] =
      <span class="hljs-type">ZIO</span>.accessM(_.get.foo)
  }

  <span class="hljs-keyword">val</span> env = (<span class="hljs-type">ModuleA</span>.live ++ <span class="hljs-type">ModuleB</span>.live ++ <span class="hljs-type">ZLayer</span>.identity[<span class="hljs-type">Clock</span>]) &gt;&gt;&gt; <span class="hljs-type">ModuleC</span>.live

  <span class="hljs-keyword">val</span> res = <span class="hljs-type">ModuleC</span>.foo.provideCustomLayer(env)

  <span class="hljs-keyword">val</span> out = rt.unsafeRun(res)
  println(out)
  <span class="hljs-comment">// 42</span>
}
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/datatypes/contextual/has"><span class="arrow-prev">← </span><span>Has</span></a><a class="docs-next button" href="/docs/datatypes/contextual/rlayer"><span>RLayer</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#creation">Creation</a><ul class="toc-headings"><li><a href="#from-simple-values">From Simple Values</a></li><li><a href="#from-managed-resources">From Managed Resources</a></li><li><a href="#from-zio-effects">From ZIO Effects</a></li><li><a href="#from-another-service">From another Service</a></li></ul></li><li><a href="#vertical-and-horizontal-composition">Vertical and Horizontal Composition</a></li><li><a href="#layer-memoization">Layer Memoization</a></li><li><a href="#updating-local-dependencies">Updating Local Dependencies</a></li><li><a href="#hidden-versus-passed-through-dependencies">Hidden Versus Passed Through Dependencies</a></li><li><a href="#cyclic-dependencies">Cyclic Dependencies</a></li><li><a href="#asynchronous-service-construction">Asynchronous Service Construction</a></li><li><a href="#examples">Examples</a><ul class="toc-headings"><li><a href="#the-simplest-zlayer-application">The simplest ZLayer application</a></li><li><a href="#zlayer-application-with-dependencies">ZLayer application with dependencies</a></li><li><a href="#zlayer-example-with-complex-dependencies">ZLayer example with complex dependencies</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/navbar_brand.png" alt="ZIO"/></a><div><h5>GitHub</h5><a href="https://github.com/zio/zio"><img src="https://img.shields.io/github/stars/zio/zio?style=social" alt="github"/></a></div><div><h5>Chat with us on Discord</h5><a href="https://discord.gg/2ccFBr4"><img src="https://img.shields.io/discord/629491597070827530?logo=discord&amp;style=social" alt="discord"/></a></div><div><h5>Follow us on Twitter</h5><a href="https://twitter.com/zioscala"><img src="https://img.shields.io/twitter/follow/zioscala?label=Follow&amp;style=social" alt="twitter"/></a></div><div><h5>Additional resources</h5><a href="https://javadoc.io/doc/dev.zio/zio_2.12/">Scaladoc of zio</a></div><div><a href="https://www.netlify.com"><img src="https://www.netlify.com/img/global/badges/netlify-color-accent.svg" alt="Deploys by Netlify"/></a></div></section><section class="copyright">Copyright © 2021 ZIO Maintainers</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '0c94b59071da7001757d08ab43d9e033',
                indexName: 'zio',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>