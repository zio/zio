<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-zio-http docs-doc-id-v1.x/dsl/middleware">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Middleware | ZIO</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zio.dev/zio-http/v1.x/dsl/middleware"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-zio-http-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-zio-http-current"><meta data-rh="true" property="og:title" content="Middleware | ZIO"><meta data-rh="true" name="description" content="What is a &quot;Middleware&quot;?"><meta data-rh="true" property="og:description" content="What is a &quot;Middleware&quot;?"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://zio.dev/zio-http/v1.x/dsl/middleware"><link data-rh="true" rel="alternate" href="https://zio.dev/zio-http/v1.x/dsl/middleware" hreflang="en"><link data-rh="true" rel="alternate" href="https://zio.dev/zio-http/v1.x/dsl/middleware" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://IAX8GRSWEQ-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-237088290-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SH0HNKLNRT"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-SH0HNKLNRT",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="ZIO" href="/opensearch.xml">
















































<link rel="stylesheet" href="/css/prism/prism-material-dark.css"><link rel="stylesheet" href="/assets/css/styles.3ac761dc.css">
<link rel="preload" href="/assets/js/runtime~main.45d048c3.js" as="script">
<link rel="preload" href="/assets/js/main.c278ee17.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/navbar_brand.png" alt="ZIO" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/navbar_brand.png" alt="ZIO" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/overview/">Overview</a><a class="navbar__item navbar__link" href="/reference/">Reference</a><a class="navbar__item navbar__link" href="/guides/">Guides</a><a class="navbar__item navbar__link" href="/ecosystem/">Ecosystem</a><a class="navbar__item navbar__link" href="/resources/">Resources</a><a class="navbar__item navbar__link" href="/about/">About</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/overview/">ZIO 2.x</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/overview/">ZIO 2.x</a></li><li><a class="dropdown__link" href="/version-1.x/overview/">ZIO 1.x</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/zio-http/v1.x/">v1.x</a><button aria-label="Toggle the collapsible sidebar category &#x27;v1.x&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/v1.x/getting-started">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/zio-http/v1.x/dsl/server">DSL</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/v1.x/dsl/server">Server</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/v1.x/dsl/http">Http</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/v1.x/dsl/request">Request</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/v1.x/dsl/response">Response</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/v1.x/dsl/body">Body</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/v1.x/dsl/headers">Headers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/v1.x/dsl/cookies">Cookie</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/zio-http/v1.x/dsl/middleware">Middleware</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/zio-http/v1.x/dsl/socket/">Socket</a><button aria-label="Toggle the collapsible sidebar category &#x27;Socket&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/v1.x/client/">Client</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/v1.x/testing/">Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zio-http/v1.x/integrations/">Integrations</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/zio-http/v1.x/examples/zio-http-basic-examples/http_client">Examples</a></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zio-http/">index</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/zio-http/v1.x/"><span itemprop="name">v1.x</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">DSL</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Middleware</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Middleware</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-a-middleware">What is a &quot;Middleware&quot;?<a class="hash-link" href="#what-is-a-middleware" title="Direct link to heading">​</a></h2><p>Before introducing middleware, let us understand why they are needed.</p><p>Consider the following example where we have two endpoints within HttpApp</p><ul><li>GET a single user by id</li><li>GET all users</li></ul><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token plain">  </span><span class="token keyword">private</span><span class="token plain"> </span><span class="token keyword">val</span><span class="token plain"> app </span><span class="token operator">=</span><span class="token plain"> Http</span><span class="token punctuation">.</span><span class="token plain">collectZIO</span><span class="token punctuation">[</span><span class="token plain">Request</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> Method</span><span class="token punctuation">.</span><span class="token plain">GET </span><span class="token operator">-&gt;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token operator">!</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token string">&quot;users&quot;</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> id </span><span class="token keyword">=&gt;</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">      </span><span class="token comment">// core business logic  </span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">      dbService</span><span class="token punctuation">.</span><span class="token plain">lookupUsersById</span><span class="token punctuation">(</span><span class="token plain">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token plain">map</span><span class="token punctuation">(</span><span class="token plain">Response</span><span class="token punctuation">.</span><span class="token plain">json</span><span class="token punctuation">(</span><span class="token plain">_</span><span class="token punctuation">.</span><span class="token plain">json</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> Method</span><span class="token punctuation">.</span><span class="token plain">GET </span><span class="token operator">-&gt;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token operator">!</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token string">&quot;users&quot;</span><span class="token plain">    </span><span class="token keyword">=&gt;</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">      </span><span class="token comment">// core business logic  </span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">      dbService</span><span class="token punctuation">.</span><span class="token plain">paginatedUsers</span><span class="token punctuation">(</span><span class="token plain">pageNum</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token plain">map</span><span class="token punctuation">(</span><span class="token plain">Response</span><span class="token punctuation">.</span><span class="token plain">json</span><span class="token punctuation">(</span><span class="token plain">_</span><span class="token punctuation">.</span><span class="token plain">json</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-polluted-code-violates-the-principle-of-separation-of-concerns">The polluted code violates the principle of &quot;Separation of concerns&quot;<a class="hash-link" href="#the-polluted-code-violates-the-principle-of-separation-of-concerns" title="Direct link to heading">​</a></h4><p>As our application grows, we want to code the following aspects like</p><ul><li>Basic Auth</li><li>Request logging</li><li>Response logging</li><li>Timeout and retry</li></ul><p>For both of our example endpoints, our core business logic gets buried under boilerplate like this</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token plain">            </span><span class="token punctuation">(</span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">                </span><span class="token comment">// validate user</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">                _    </span><span class="token keyword">&lt;-</span><span class="token plain"> MyAuthService</span><span class="token punctuation">.</span><span class="token plain">doAuth</span><span class="token punctuation">(</span><span class="token plain">request</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">                </span><span class="token comment">// log request</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">                _    </span><span class="token keyword">&lt;-</span><span class="token plain"> logRequest</span><span class="token punctuation">(</span><span class="token plain">request</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">                </span><span class="token comment">// core business logic</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">                user </span><span class="token keyword">&lt;-</span><span class="token plain"> dbService</span><span class="token punctuation">.</span><span class="token plain">lookupUsersById</span><span class="token punctuation">(</span><span class="token plain">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token plain">map</span><span class="token punctuation">(</span><span class="token plain">Response</span><span class="token punctuation">.</span><span class="token plain">json</span><span class="token punctuation">(</span><span class="token plain">_</span><span class="token punctuation">.</span><span class="token plain">json</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">                resp </span><span class="token keyword">&lt;-</span><span class="token plain"> Response</span><span class="token punctuation">.</span><span class="token plain">json</span><span class="token punctuation">(</span><span class="token plain">user</span><span class="token punctuation">.</span><span class="token plain">toJson</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">                </span><span class="token comment">// log response</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">                _    </span><span class="token keyword">&lt;-</span><span class="token plain"> logResponse</span><span class="token punctuation">(</span><span class="token plain">resp</span><span class="token punctuation">)</span><span class="token plain">                </span><br></span><span class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">yield</span><span class="token plain"> resp</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">                    </span><span class="token punctuation">.</span><span class="token plain">timeout</span><span class="token punctuation">(</span><span class="token number">2.</span><span class="token plain">seconds</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">                    </span><span class="token punctuation">.</span><span class="token plain">retryN</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Imagine repeating this for all our endpoints!!!</p><p>So there are two problems with this approach</p><ul><li>We are dangerously coupling our business logic with cross-cutting concerns (like applying timeouts)</li><li>Also, addressing these concerns will require updating code for every single route in the system. For 100 routes we will need to repeat 100 timeouts!!!</li><li>For example, any change related to a concern like the logging mechanism from logback to log4j2 may cause changing signature of <code>log(..)</code> function in 100 places.</li><li>On the other hand, this also makes testing core business logic more cumbersome.</li></ul><p>This can lead to a lot of boilerplate clogging our neatly written endpoints affecting readability, thereby leading to increased maintenance costs.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="need-for-middlewares-and-handling-aspects">Need for middlewares and handling &quot;aspects&quot;<a class="hash-link" href="#need-for-middlewares-and-handling-aspects" title="Direct link to heading">​</a></h2><p>If we refer to Wikipedia for the definition of an &quot;<a href="https://en.wikipedia.org/wiki/Aspect_(computer_programming)" target="_blank" rel="noopener noreferrer">Aspect</a>&quot; we can glean the following points.</p><ul><li>An aspect of a program is a feature linked to many other parts of the program (<strong><em>most common example, logging</em></strong>)., </li><li>But it is not related to the program&#x27;s primary function (<strong><em>core business logic</em></strong>) </li><li>An aspect crosscuts the program&#x27;s core concerns (<strong><em>for example logging code intertwined with core business logic</em></strong>),  </li><li>Therefore, it can violate the principle of &quot;separation of concerns&quot; which tries to encapsulate unrelated functions. (<strong><em>Code duplication and maintenance nightmare</em></strong>)</li></ul><p>Or in short, aspect is a common concern required throughout the application, and its implementation could lead to repeated boilerplate code and in violation of the principle of separation of concerns.
There is a paradigm in the programming world called <a href="https://en.wikipedia.org/wiki/Aspect-oriented_programming" target="_blank" rel="noopener noreferrer">aspect-oriented programming</a> that aims for modular handling of these common concerns in an application. </p><p>Some examples of common &quot;aspects&quot; required throughout the application</p><ul><li>logging,</li><li>timeouts (preventing long-running code)</li><li>retries (or handling flakiness for example while accessing third party APIs)</li><li>authenticating a user before using the REST resource (basic, or custom ones like OAuth / single sign-on, etc).</li></ul><p>This is where middleware comes to the rescue.
Using middlewares we can compose out-of-the-box middlewares (or our custom middlewares) to address the above-mentioned concerns using ++ and @@ operators as shown below.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="cleaned-up-code-using-middleware-to-address-cross-cutting-concerns-like-auth-requestresponse-logging-etc">Cleaned up code using middleware to address cross-cutting concerns like auth, request/response logging, etc.<a class="hash-link" href="#cleaned-up-code-using-middleware-to-address-cross-cutting-concerns-like-auth-requestresponse-logging-etc" title="Direct link to heading">​</a></h4><p>Observe, how we can address multiple cross-cutting concerns using neatly composed middlewares, in a single place.</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token comment">// compose basic auth, request/response logging, timeouts middlewares</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">val</span><span class="token plain"> composedMiddlewares </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">basicAuth</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;pw&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">++</span><span class="token plain"> </span><br></span><span class="token-line"><span class="token plain">        Middleware</span><span class="token punctuation">.</span><span class="token plain">debug </span><span class="token operator">++</span><span class="token plain"> </span><br></span><span class="token-line"><span class="token plain">        Middleware</span><span class="token punctuation">.</span><span class="token plain">timeout</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token plain"> seconds</span><span class="token punctuation">)</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And then we can attach our composed bundle of middlewares to an Http using <code>@@</code></p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">private</span><span class="token plain"> </span><span class="token keyword">val</span><span class="token plain"> app </span><span class="token operator">=</span><span class="token plain"> Http</span><span class="token punctuation">.</span><span class="token plain">collectZIO</span><span class="token punctuation">[</span><span class="token plain">Request</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">case</span><span class="token plain"> Method</span><span class="token punctuation">.</span><span class="token plain">GET </span><span class="token operator">-&gt;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token operator">!</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token string">&quot;users&quot;</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> id </span><span class="token keyword">=&gt;</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    </span><span class="token comment">// core business logic  </span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    dbService</span><span class="token punctuation">.</span><span class="token plain">lookupUsersById</span><span class="token punctuation">(</span><span class="token plain">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token plain">map</span><span class="token punctuation">(</span><span class="token plain">Response</span><span class="token punctuation">.</span><span class="token plain">json</span><span class="token punctuation">(</span><span class="token plain">_</span><span class="token punctuation">.</span><span class="token plain">json</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">case</span><span class="token plain"> Method</span><span class="token punctuation">.</span><span class="token plain">GET </span><span class="token operator">-&gt;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token operator">!</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token string">&quot;users&quot;</span><span class="token plain">    </span><span class="token keyword">=&gt;</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    </span><span class="token comment">// core business logic  </span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    dbService</span><span class="token punctuation">.</span><span class="token plain">paginatedUsers</span><span class="token punctuation">(</span><span class="token plain">pageNum</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token plain">map</span><span class="token punctuation">(</span><span class="token plain">Response</span><span class="token punctuation">.</span><span class="token plain">json</span><span class="token punctuation">(</span><span class="token plain">_</span><span class="token punctuation">.</span><span class="token plain">json</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"> @@ composedMiddlewares </span><span class="token comment">// attach composedMiddlewares to the app using @@</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Observe how we gained the following benefits by using middlewares</p><ul><li><strong>Readability</strong>: de-cluttering business logic.</li><li><strong>Modularity</strong>: we can manage aspects independently without making changes in 100 places. For example, <ul><li>replacing the logging mechanism from logback to log4j2 will require a change in one place, the logging middleware.</li><li>replacing the authentication mechanism from OAuth to single sign-on will require changing the auth middleware</li></ul></li><li><strong>Testability</strong>: we can test our aspects independently.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="middleware-in-zio-http">Middleware in zio-http<a class="hash-link" href="#middleware-in-zio-http" title="Direct link to heading">​</a></h2><p>A middleware helps in addressing common crosscutting concerns without duplicating boilerplate code.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="revisiting-http">Revisiting HTTP<a class="hash-link" href="#revisiting-http" title="Direct link to heading">​</a></h4><p><a href="https://zio.github.io/zio-http/docs/v1.x/dsl/http" target="_blank" rel="noopener noreferrer"><code>Http</code></a> is the most fundamental type for modeling Http applications</p><p><code>Http[-R, +E, -A, +B]</code> is equivalent to <code>(A) =&gt; ZIO[R, Option[E], B]</code> where</p><ul><li><code>R</code> type of Environment </li><li><code>E</code> type of the Error when the function fails with Some<!-- -->[E]</li><li><code>A</code> is the type of input given to the Http</li><li><code>B</code> type of the output produced by the Http </li></ul><p>Middleware is simply a function that takes one <code>Http</code> as a parameter and returns a new <code>Http</code> with some enhanced capabilities.,</p><p><code>Http =&gt; Http</code></p><p>So, a middleware represents function transformation f1 =&gt; f2</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">type</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token plain">R</span><span class="token punctuation">,</span><span class="token plain"> E</span><span class="token punctuation">,</span><span class="token plain"> AIn</span><span class="token punctuation">,</span><span class="token plain"> BIn</span><span class="token punctuation">,</span><span class="token plain"> AOut</span><span class="token punctuation">,</span><span class="token plain"> BOut</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Http</span><span class="token punctuation">[</span><span class="token plain">R</span><span class="token punctuation">,</span><span class="token plain"> E</span><span class="token punctuation">,</span><span class="token plain"> AIn</span><span class="token punctuation">,</span><span class="token plain"> BIn</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token keyword">=&gt;</span><span class="token plain"> Http</span><span class="token punctuation">[</span><span class="token plain">R</span><span class="token punctuation">,</span><span class="token plain"> E</span><span class="token punctuation">,</span><span class="token plain"> AOut</span><span class="token punctuation">,</span><span class="token plain"> BOut</span><span class="token punctuation">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>AIn</code> and <code>BIn</code> are type params of the input <code>Http</code></li><li><code>AOut</code> and <code>BOut</code> are type params of the output <code>Http</code></li></ul><p><strong>HttpApp</strong> is a specialized Http with <code>Request</code> and <code>Response</code> as input and output</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">type</span><span class="token plain"> HttpApp</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token plain">R</span><span class="token punctuation">,</span><span class="token operator">+</span><span class="token plain">E</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Http</span><span class="token punctuation">[</span><span class="token plain">R</span><span class="token punctuation">,</span><span class="token plain"> E</span><span class="token punctuation">,</span><span class="token plain"> Request</span><span class="token punctuation">,</span><span class="token plain"> Response</span><span class="token punctuation">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the  <code>HttpApp</code> context, a middleware can modify requests and responses and also transform them into more concrete domain entities.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="attaching-middleware-to-http">Attaching middleware to Http<a class="hash-link" href="#attaching-middleware-to-http" title="Direct link to heading">​</a></h4><p><code>@@</code> operator is used to attach a middleware to an Http. Example below shows a middleware attached to an HttpApp</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> app </span><span class="token operator">=</span><span class="token plain"> Http</span><span class="token punctuation">.</span><span class="token plain">collect</span><span class="token punctuation">[</span><span class="token plain">Request</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">case</span><span class="token plain"> Method</span><span class="token punctuation">.</span><span class="token plain">GET </span><span class="token operator">-&gt;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token operator">!</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> name </span><span class="token keyword">=&gt;</span><span class="token plain"> Response</span><span class="token punctuation">.</span><span class="token plain">text</span><span class="token punctuation">(</span><span class="token string-interpolation id function">s</span><span class="token string-interpolation string">&quot;Hello </span><span class="token string-interpolation interpolation punctuation">$</span><span class="token string-interpolation interpolation expression">name</span><span class="token string-interpolation string">&quot;</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">val</span><span class="token plain"> appWithMiddleware </span><span class="token operator">=</span><span class="token plain"> app @@ Middleware</span><span class="token punctuation">.</span><span class="token plain">debug</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Logically the code above translates to <code>Middleware.debug(app)</code></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="a-simple-middleware-example">A simple middleware example<a class="hash-link" href="#a-simple-middleware-example" title="Direct link to heading">​</a></h4><p>Let us consider a simple example using out-of-the-box middleware called <code>addHeader</code>
We will write a middleware that will attach a custom header to the response. </p><p>Start with imports</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token namespace">http</span><span class="token namespace punctuation">.</span><span class="token plain">_</span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token namespace">http</span><span class="token namespace punctuation">.</span><span class="token plain">Server</span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token namespace">console</span><span class="token namespace punctuation">.</span><span class="token punctuation">{</span><span class="token plain">putStrLn</span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token punctuation">{</span><span class="token plain">App</span><span class="token punctuation">,</span><span class="token plain"> ExitCode</span><span class="token punctuation">,</span><span class="token plain"> URIO</span><span class="token punctuation">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We create a middleware that appends an additional header to the response indicating whether it is a Dev/Prod/Staging environment.</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">lazy</span><span class="token plain"> </span><span class="token keyword">val</span><span class="token plain"> patchEnv </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">addHeader</span><span class="token punctuation">(</span><span class="token string">&quot;X-Environment&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;Dev&quot;</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A test HttpApp with attached middleware</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> app </span><span class="token operator">=</span><span class="token plain"> Http</span><span class="token punctuation">.</span><span class="token plain">collect</span><span class="token punctuation">[</span><span class="token plain">Request</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">case</span><span class="token plain"> Method</span><span class="token punctuation">.</span><span class="token plain">GET </span><span class="token operator">-&gt;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token operator">!</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> name </span><span class="token keyword">=&gt;</span><span class="token plain"> Response</span><span class="token punctuation">.</span><span class="token plain">text</span><span class="token punctuation">(</span><span class="token string-interpolation id function">s</span><span class="token string-interpolation string">&quot;Hello </span><span class="token string-interpolation interpolation punctuation">$</span><span class="token string-interpolation interpolation expression">name</span><span class="token string-interpolation string">&quot;</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">val</span><span class="token plain"> appWithMiddleware </span><span class="token operator">=</span><span class="token plain"> app @@ patchEnv</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Start the server </p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> server </span><span class="token operator">=</span><span class="token plain"> Server</span><span class="token punctuation">.</span><span class="token plain">start</span><span class="token punctuation">(</span><span class="token number">8090</span><span class="token punctuation">,</span><span class="token plain"> appWithMiddleware</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token plain">exitCode</span><br></span><span class="token-line"><span class="token plain">zio</span><span class="token punctuation">.</span><span class="token plain">Runtime</span><span class="token punctuation">.</span><span class="token plain">default</span><span class="token punctuation">.</span><span class="token plain">unsafeRunSync</span><span class="token punctuation">(</span><span class="token plain">server</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Fire a curl request and we see an additional header added to the response indicating the &quot;Dev&quot; environment</p><div class="codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token plain">curl -i http://localhost:8090/Bob</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">HTTP/1.1 200 OK</span><br></span><span class="token-line"><span class="token plain">content-type: text/plain</span><br></span><span class="token-line"><span class="token plain">X-Environment: Dev</span><br></span><span class="token-line"><span class="token plain">content-length: 12</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">Hello Bob</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="advanced-example-showing-the-transformative-power-of-a-middleware-optional">Advanced example showing the transformative power of a middleware (Optional)<a class="hash-link" href="#advanced-example-showing-the-transformative-power-of-a-middleware-optional" title="Direct link to heading">​</a></h3><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Here is a slightly longer example to explore how powerful middleware transformation can be. It shows<ul><li>How we can define a service purely in terms of our domain types</li><li>Define a &quot;codec&quot; middleware for decoding requests and encoding responses to and from domain types</li><li>Transform our regular `Http` service to an HttpApp by applying our codec middleware</li></ul><b><i>Note: In real life, we will be using REST endpoints for defining routes. Although you can skip this section, this example gives a deeper insight into middleware.</i></b></summary><div><div class="collapsibleContent_i85q"><p>Start with imports</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token namespace">http</span><span class="token namespace punctuation">.</span><span class="token punctuation">{</span><span class="token plain">Http</span><span class="token punctuation">,</span><span class="token plain"> HttpError</span><span class="token punctuation">,</span><span class="token plain"> Middleware</span><span class="token punctuation">,</span><span class="token plain"> Request</span><span class="token punctuation">,</span><span class="token plain"> Response</span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token punctuation">{</span><span class="token plain">ExitCode</span><span class="token punctuation">,</span><span class="token plain"> URIO</span><span class="token punctuation">,</span><span class="token plain"> ZEnv</span><span class="token punctuation">,</span><span class="token plain"> ZIO</span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token namespace">json</span><span class="token namespace punctuation">.</span><span class="token plain">_</span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token namespace">http</span><span class="token namespace punctuation">.</span><span class="token namespace">service</span><span class="token namespace punctuation">.</span><span class="token plain">_</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Define some &quot;User&quot; domain types</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">final</span><span class="token plain"> </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> User</span><span class="token punctuation">(</span><span class="token plain">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token plain"> email</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token plain"> id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">object</span><span class="token plain"> User </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">implicit</span><span class="token plain"> </span><span class="token keyword">val</span><span class="token plain"> codec</span><span class="token operator">:</span><span class="token plain"> JsonCodec</span><span class="token punctuation">[</span><span class="token plain">User</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> DeriveJsonCodec</span><span class="token punctuation">.</span><span class="token plain">gen</span><span class="token punctuation">[</span><span class="token plain">User</span><span class="token punctuation">]</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">sealed</span><span class="token plain"> </span><span class="token keyword">trait</span><span class="token plain"> UsersRequest</span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">object</span><span class="token plain"> UsersRequest </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">final</span><span class="token plain"> </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> Get</span><span class="token punctuation">(</span><span class="token plain">id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token plain">                        </span><span class="token keyword">extends</span><span class="token plain"> UsersRequest</span><br></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">final</span><span class="token plain"> </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> Create</span><span class="token punctuation">(</span><span class="token plain">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token plain"> email</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> UsersRequest</span><br></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">implicit</span><span class="token plain"> </span><span class="token keyword">val</span><span class="token plain"> decoder</span><span class="token operator">:</span><span class="token plain"> JsonDecoder</span><span class="token punctuation">[</span><span class="token plain">UsersRequest</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> DeriveJsonDecoder</span><span class="token punctuation">.</span><span class="token plain">gen</span><span class="token punctuation">[</span><span class="token plain">UsersRequest</span><span class="token punctuation">]</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">sealed</span><span class="token plain"> </span><span class="token keyword">trait</span><span class="token plain"> UsersResponse</span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">object</span><span class="token plain"> UsersResponse </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">final</span><span class="token plain"> </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> Got</span><span class="token punctuation">(</span><span class="token plain">user</span><span class="token operator">:</span><span class="token plain"> User</span><span class="token punctuation">)</span><span class="token plain">     </span><span class="token keyword">extends</span><span class="token plain"> UsersResponse</span><br></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">final</span><span class="token plain"> </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> Created</span><span class="token punctuation">(</span><span class="token plain">user</span><span class="token operator">:</span><span class="token plain"> User</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> UsersResponse</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">  </span><span class="token keyword">implicit</span><span class="token plain"> </span><span class="token keyword">val</span><span class="token plain"> encoder</span><span class="token operator">:</span><span class="token plain"> JsonEncoder</span><span class="token punctuation">[</span><span class="token plain">UsersResponse</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> DeriveJsonEncoder</span><span class="token punctuation">.</span><span class="token plain">gen</span><span class="token punctuation">[</span><span class="token plain">UsersResponse</span><span class="token punctuation">]</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Define a Users service <em><strong>purely in terms of our types</strong></em></p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token plain">  </span><span class="token keyword">val</span><span class="token plain"> usersService</span><span class="token operator">:</span><span class="token plain"> Http</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> UsersRequest</span><span class="token punctuation">,</span><span class="token plain"> UsersResponse</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Http</span><span class="token punctuation">.</span><span class="token plain">collect </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> UsersRequest</span><span class="token punctuation">.</span><span class="token plain">Create</span><span class="token punctuation">(</span><span class="token plain">name</span><span class="token punctuation">,</span><span class="token plain"> email</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">      UsersResponse</span><span class="token punctuation">.</span><span class="token plain">Created</span><span class="token punctuation">(</span><span class="token plain">User</span><span class="token punctuation">(</span><span class="token plain">name</span><span class="token punctuation">,</span><span class="token plain"> email</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;abc123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> UsersRequest</span><span class="token punctuation">.</span><span class="token plain">Get</span><span class="token punctuation">(</span><span class="token plain">id</span><span class="token punctuation">)</span><span class="token plain">             </span><span class="token keyword">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">      UsersResponse</span><span class="token punctuation">.</span><span class="token plain">Got</span><span class="token punctuation">(</span><span class="token plain">User</span><span class="token punctuation">(</span><span class="token plain">id</span><span class="token punctuation">.</span><span class="token plain">toString</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A codec middleware which transforms an <code>Http</code> with different input/output types to <code>HttpApp</code> with <strong>Request and Response</strong></p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token plain">  </span><span class="token keyword">def</span><span class="token plain"> codecMiddleware</span><span class="token punctuation">[</span><span class="token plain">In</span><span class="token operator">:</span><span class="token plain"> JsonDecoder</span><span class="token punctuation">,</span><span class="token plain"> Out</span><span class="token operator">:</span><span class="token plain"> JsonEncoder</span><span class="token punctuation">]</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain">In</span><span class="token punctuation">,</span><span class="token plain">Out</span><span class="token punctuation">,</span><span class="token plain">Request</span><span class="token punctuation">,</span><span class="token plain">Response</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    Middleware</span><span class="token punctuation">.</span><span class="token plain">codecZIO</span><span class="token punctuation">[</span><span class="token plain">Request</span><span class="token punctuation">,</span><span class="token plain">Out</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">      </span><span class="token comment">// deserialize the request into In type or fail with some message</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">      request </span><span class="token keyword">=&gt;</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">        </span><span class="token keyword">for</span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">          body </span><span class="token keyword">&lt;-</span><span class="token plain"> request</span><span class="token punctuation">.</span><span class="token plain">getBodyAsString</span><br></span><span class="token-line"><span class="token plain">          in   </span><span class="token keyword">&lt;-</span><span class="token plain"> ZIO</span><span class="token punctuation">.</span><span class="token plain">fromEither</span><span class="token punctuation">(</span><span class="token plain">JsonDecoder</span><span class="token punctuation">[</span><span class="token plain">In</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token plain">decodeJson</span><span class="token punctuation">(</span><span class="token plain">body</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">yield</span><span class="token plain"> in</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">      out </span><span class="token keyword">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">        </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">          charSeq </span><span class="token keyword">&lt;-</span><span class="token plain"> ZIO</span><span class="token punctuation">(</span><span class="token plain">JsonEncoder</span><span class="token punctuation">[</span><span class="token plain">Out</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token plain">encodeJson</span><span class="token punctuation">(</span><span class="token plain">out</span><span class="token punctuation">,</span><span class="token plain"> None</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">yield</span><span class="token plain"> Response</span><span class="token punctuation">.</span><span class="token plain">json</span><span class="token punctuation">(</span><span class="token plain">charSeq</span><span class="token punctuation">.</span><span class="token plain">toString</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token generics punctuation">&lt;</span><span class="token generics punctuation">&gt;</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">succeed</span><span class="token punctuation">(</span><span class="token plain">Response</span><span class="token punctuation">.</span><span class="token plain">fromHttpError</span><span class="token punctuation">(</span><span class="token plain">HttpError</span><span class="token punctuation">.</span><span class="token plain">BadRequest</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid JSON&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let us transform our regular Http with UserService to an HttpApp using our codec middleware</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> transformedHttpApp</span><span class="token operator">:</span><span class="token plain"> Http</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> Request</span><span class="token punctuation">,</span><span class="token plain"> Response</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    usersService @@ codecMiddleware</span><span class="token punctuation">[</span><span class="token plain">UsersRequest</span><span class="token punctuation">,</span><span class="token plain">UsersResponse</span><span class="token punctuation">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Just observe how our service <code>Http</code> got transformed to <code>HttpApp</code> by applying middleware</p><p><code>Http[Any, Nothing, UsersRequest, UsersResponse]</code> ===&gt; <code>Http[Any, Nothing, Request, Response]</code> (HttpApp)</p><p>Start the server</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> server </span><span class="token operator">=</span><span class="token plain"> Server</span><span class="token punctuation">.</span><span class="token plain">start</span><span class="token punctuation">(</span><span class="token number">8090</span><span class="token punctuation">,</span><span class="token plain"> transformedHttpApp</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">zio</span><span class="token punctuation">.</span><span class="token plain">Runtime</span><span class="token punctuation">.</span><span class="token plain">default</span><span class="token punctuation">.</span><span class="token plain">unsafeRunSync</span><span class="token punctuation">(</span><span class="token plain">server</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Fire a curl request along with the request body</p><div class="codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token plain">curl -i -d &#x27;{ &quot;Create&quot;:{ &quot;name&quot;:&quot;Sum&quot;, &quot;email&quot;: &quot;s@d1.com&quot; }}&#x27; http://localhost:8090/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Observe the response</p><div class="codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token plain">HTTP/1.1 200 OK</span><br></span><span class="token-line"><span class="token plain">content-type: application/json</span><br></span><span class="token-line"><span class="token plain">content-length: 68</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">{&quot;Created&quot;:{&quot;user&quot;:{&quot;name&quot;:&quot;Sum&quot;,&quot;email&quot;:&quot;s@d1.com&quot;,&quot;id&quot;:&quot;abc123&quot;}}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-middleware">Creating Middleware<a class="hash-link" href="#creating-middleware" title="Direct link to heading">​</a></h2><p>Refer to <a href="https://github.com/zio/zio-http/blob/main/zio-http/src/main/scala/zio/http/Middleware.scala" target="_blank" rel="noopener noreferrer">Middleware.scala</a> for various ways of creating a middleware.</p><p>Again remember that a &quot;middleware&quot; is just a <strong><em>transformative function</em></strong>. There are ways of creating such transformative functions:  </p><ul><li><strong>identity</strong>: works like an <a href="https://en.wikipedia.org/wiki/Identity_function" target="_blank" rel="noopener noreferrer">identity function</a> in mathematics
<code>f(x) = x</code>.
It returns the same <code>Http</code> as input without doing any modification</li></ul><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> identityMW</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">identity</span><br></span><span class="token-line"><span class="token plain">app @@ identityMW </span><span class="token comment">// no effect on the http app.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>succeed</strong> creates a middleware that always returns the output <code>Http</code> that succeeds with the given value and never fails.</li></ul><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> middleware</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">succeed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>fail</strong> creates a middleware that always returns the output <code>Http</code> that always fails.</li></ul><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> middleware</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">fail</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>collect</strong> creates middleware using a specified function</li></ul><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> middleware</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> Request</span><span class="token punctuation">,</span><span class="token plain"> Response</span><span class="token punctuation">,</span><span class="token plain"> Request</span><span class="token punctuation">,</span><span class="token plain"> Response</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">collect</span><span class="token punctuation">[</span><span class="token plain">Request</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token plain">_ </span><span class="token keyword">=&gt;</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">addHeaders</span><span class="token punctuation">(</span><span class="token plain">Headers</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>collectZIO</strong> creates middleware using a specified effect function</li></ul><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> middleware</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> Request</span><span class="token punctuation">,</span><span class="token plain"> Response</span><span class="token punctuation">,</span><span class="token plain"> Request</span><span class="token punctuation">,</span><span class="token plain"> Response</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">collectZIO</span><span class="token punctuation">[</span><span class="token plain">Request</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token plain">_ </span><span class="token keyword">=&gt;</span><span class="token plain"> ZIO</span><span class="token punctuation">.</span><span class="token plain">succeed</span><span class="token punctuation">(</span><span class="token plain">Middleware</span><span class="token punctuation">.</span><span class="token plain">addHeaders</span><span class="token punctuation">(</span><span class="token plain">Headers</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>codec</strong> takes two functions <code>decoder: AOut =&gt; Either[E, AIn]</code> and <code>encoder: BIn =&gt; Either[E, BOut]</code></li></ul><p>The below snippet takes two functions:</p><ul><li>decoder function to decode Request to String</li><li>encoder function to encode String to Response</li></ul><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> middleware</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token plain"> Request</span><span class="token punctuation">,</span><span class="token plain"> Response</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">codec</span><span class="token punctuation">[</span><span class="token plain">Request</span><span class="token punctuation">,</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token plain">r </span><span class="token keyword">=&gt;</span><span class="token plain"> Right</span><span class="token punctuation">(</span><span class="token plain">r</span><span class="token punctuation">.</span><span class="token plain">method</span><span class="token punctuation">.</span><span class="token plain">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> s </span><span class="token keyword">=&gt;</span><span class="token plain"> Right</span><span class="token punctuation">(</span><span class="token plain">Response</span><span class="token punctuation">.</span><span class="token plain">text</span><span class="token punctuation">(</span><span class="token plain">s</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>fromHttp</strong> creates a middleware with output <code>Http</code> as specified <code>http</code></li></ul><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> app</span><span class="token operator">:</span><span class="token plain"> Http</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Http</span><span class="token punctuation">.</span><span class="token plain">succeed</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">val</span><span class="token plain"> middleware</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> Request</span><span class="token punctuation">,</span><span class="token plain"> Response</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">fromHttp</span><span class="token punctuation">(</span><span class="token plain">app</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="combining-middlewares">Combining middlewares<a class="hash-link" href="#combining-middlewares" title="Direct link to heading">​</a></h2><p>Middlewares can be combined using several special operators like <code>++</code>, <code>&lt;&gt;</code> and <code>&gt;&gt;&gt;</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="using--combinator">Using <code>++</code> combinator<a class="hash-link" href="#using--combinator" title="Direct link to heading">​</a></h3><p><code>++</code> is an alias for <code>combine</code>. It combines two middlewares <strong><em>without changing their input/output types (<code>AIn</code> = <code>AOut</code> / <code>BIn</code> = <code>BOut</code>)</em></strong></p><p>For example, if we have three middlewares f1, f2, f3</p><p>f1 ++ f2 ++ f3 applies on an <code>http</code>, from left to right with f1 first followed by others, like this </p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token plain">  f3</span><span class="token punctuation">(</span><span class="token plain">f2</span><span class="token punctuation">(</span><span class="token plain">f1</span><span class="token punctuation">(</span><span class="token plain">http</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="a-simple-example-using--combinator">A simple example using <code>++</code> combinator<a class="hash-link" href="#a-simple-example-using--combinator" title="Direct link to heading">​</a></h4><p>Start with imports</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token namespace">http</span><span class="token namespace punctuation">.</span><span class="token plain">Middleware</span><span class="token punctuation">.</span><span class="token plain">basicAuth</span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token namespace">http</span><span class="token namespace punctuation">.</span><span class="token plain">_</span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token namespace">http</span><span class="token namespace punctuation">.</span><span class="token plain">Server</span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token namespace">console</span><span class="token namespace punctuation">.</span><span class="token namespace">putStrLn</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token punctuation">{</span><span class="token plain">App</span><span class="token punctuation">,</span><span class="token plain"> ExitCode</span><span class="token punctuation">,</span><span class="token plain"> URIO</span><span class="token punctuation">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A user app with single endpoint that welcomes a user</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> userApp</span><span class="token operator">:</span><span class="token plain"> UHttpApp </span><span class="token operator">=</span><span class="token plain"> Http</span><span class="token punctuation">.</span><span class="token plain">collect</span><span class="token punctuation">[</span><span class="token plain">Request</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token keyword">case</span><span class="token plain"> Method</span><span class="token punctuation">.</span><span class="token plain">GET </span><span class="token operator">-&gt;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token operator">!</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token string">&quot;user&quot;</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> name </span><span class="token operator">/</span><span class="token plain"> </span><span class="token string">&quot;greet&quot;</span><span class="token plain"> </span><span class="token keyword">=&gt;</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">  Response</span><span class="token punctuation">.</span><span class="token plain">text</span><span class="token punctuation">(</span><span class="token string-interpolation id function">s</span><span class="token string-interpolation string">&quot;Welcome to the ZIO party! </span><span class="token string-interpolation interpolation punctuation">${</span><span class="token string-interpolation interpolation expression">name</span><span class="token string-interpolation interpolation punctuation">}</span><span class="token string-interpolation string">&quot;</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A basicAuth middleware with hardcoded user pw and another patches response with environment value </p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> basicAuthMW </span><span class="token operator">=</span><span class="token plain"> basicAuth</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">lazy</span><span class="token plain"> </span><span class="token keyword">val</span><span class="token plain"> patchEnv </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">addHeader</span><span class="token punctuation">(</span><span class="token string">&quot;X-Environment&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;Dev&quot;</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token comment">// apply combined middlewares to the userApp</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">val</span><span class="token plain"> appWithMiddleware </span><span class="token operator">=</span><span class="token plain"> userApp @@ </span><span class="token punctuation">(</span><span class="token plain">basicAuthMW </span><span class="token operator">++</span><span class="token plain"> patchEnv</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Start the server</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> server </span><span class="token operator">=</span><span class="token plain"> Server</span><span class="token punctuation">.</span><span class="token plain">start</span><span class="token punctuation">(</span><span class="token number">8090</span><span class="token punctuation">,</span><span class="token plain"> appWithMiddleware</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token plain">exitCode</span><br></span><span class="token-line"><span class="token plain">zio</span><span class="token punctuation">.</span><span class="token plain">Runtime</span><span class="token punctuation">.</span><span class="token plain">default</span><span class="token punctuation">.</span><span class="token plain">unsafeRunSync</span><span class="token punctuation">(</span><span class="token plain">server</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Fire a curl request with an incorrect user/password combination</p><div class="codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token plain">curl -i --user admin:wrong http://localhost:8090/user/admin/greet</span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">HTTP/1.1 401 Unauthorized</span><br></span><span class="token-line"><span class="token plain">www-authenticate: Basic</span><br></span><span class="token-line"><span class="token plain">X-Environment: Dev</span><br></span><span class="token-line"><span class="token plain">content-length: 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We notice in the response that first basicAuth middleware responded <code>HTTP/1.1 401 Unauthorized</code> and then patch middleware attached a <code>X-Environment: Dev</code> header. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="using-">Using <code>&gt;&gt;&gt;</code><a class="hash-link" href="#using-" title="Direct link to heading">​</a></h3><p><code>&gt;&gt;&gt;</code> is an alias for <code>andThen</code> and similar to <code>++</code> with one BIG difference <strong><em>input/output types can be different (<code>AIn</code>≠ <code>AOut</code> / <code>BIn</code>≠ <code>BOut</code>)</em></strong><br>
<!-- -->Whereas, in the case of <code>++</code> types remain the same (horizontal composition).</p><p>For example, if we have three middlewares f1, f2, f3</p><p>f1 &gt;&gt;&gt; f2 &gt;&gt;&gt; f3 applies on an <code>http</code>, sequentially feeding an http to f1 first followed by f2 and f3.</p><p>f1(http) =&gt; http1
f2(http1) =&gt; http2</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="using--combinator-1">Using <code>&lt;&gt;</code> combinator<a class="hash-link" href="#using--combinator-1" title="Direct link to heading">​</a></h3><p><code>&lt;&gt;</code> is an alias for <code>orElse</code>. While using <code>&lt;&gt;</code>, if the output <code>Http</code> of the first middleware fails, the second middleware will be evaluated, ignoring the result from the first.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="a-simple-example-using-">A simple example using <code>&lt;&gt;</code><a class="hash-link" href="#a-simple-example-using-" title="Direct link to heading">​</a></h4><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> middleware</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> Request</span><span class="token punctuation">,</span><span class="token plain"> Response</span><span class="token punctuation">,</span><span class="token plain"> Request</span><span class="token punctuation">,</span><span class="token plain"> Response</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">fail</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token generics punctuation">&lt;</span><span class="token generics punctuation">&gt;</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">addHeader</span><span class="token punctuation">(</span><span class="token string">&quot;X-Environment&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;Dev&quot;</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="other-operators">other operators<a class="hash-link" href="#other-operators" title="Direct link to heading">​</a></h4><ul><li><p><strong>contraMap</strong>,<strong>contraMapZIO</strong>,<strong>delay</strong>,<strong>flatMap</strong>,<strong>flatten</strong>,<strong>map</strong>: which are obvious as their name implies.</p></li><li><p><strong>race</strong> to race middlewares</p></li><li><p><strong>runAfter</strong> and <strong>runBefore</strong> to run effect before and after</p></li><li><p><strong>when</strong> to conditionally run a middleware (input of output Http meets some criteria)</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transforming-middlewares-some-advanced-examples">Transforming Middlewares (some advanced examples)<a class="hash-link" href="#transforming-middlewares-some-advanced-examples" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="transforming-the-output-of-the-output-http">Transforming the output of the output <code>Http</code><a class="hash-link" href="#transforming-the-output-of-the-output-http" title="Direct link to heading">​</a></h3><ul><li>We can use <code>flatMap</code> or  <code>map</code> or <code>mapZIO</code> for transforming the output type of output Http</li></ul><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> middleware</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">succeed</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">val</span><span class="token plain"> mid1</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> middleware</span><span class="token punctuation">.</span><span class="token plain">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">i</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">=&gt;</span><span class="token plain"> i</span><span class="token punctuation">.</span><span class="token plain">toString</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">val</span><span class="token plain"> mid2</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> middleware</span><span class="token punctuation">.</span><span class="token plain">mapZIO</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">i</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">=&gt;</span><span class="token plain"> ZIO</span><span class="token punctuation">.</span><span class="token plain">succeed</span><span class="token punctuation">(</span><span class="token string-interpolation id function">s</span><span class="token string-interpolation string">&quot;</span><span class="token string-interpolation interpolation punctuation">$</span><span class="token string-interpolation interpolation expression">i</span><span class="token string-interpolation string">&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">val</span><span class="token plain"> mid3</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> middleware</span><span class="token punctuation">.</span><span class="token plain">flatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">m</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">=&gt;</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">succeed</span><span class="token punctuation">(</span><span class="token plain">m</span><span class="token punctuation">.</span><span class="token plain">toString</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>We can use <code>intercept</code> or <code>interceptZIO</code> to create a new middleware using transformation functions, which changes the output type of the output <code>Http</code> keeping input the same.</p><p>The below snippet takes two functions:</p><ul><li>(incoming: A =&gt; S)</li><li>(outgoing: (B, S) =&gt; BOut) </li></ul></li></ul><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> middleware</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">intercept</span><span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token plain">_</span><span class="token punctuation">.</span><span class="token plain">toInt </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">_</span><span class="token punctuation">,</span><span class="token plain"> a</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">=&gt;</span><span class="token plain"> a </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">  </span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">val</span><span class="token plain"> mid</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">interceptZIO</span><span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token plain">i </span><span class="token keyword">=&gt;</span><span class="token plain"> UIO</span><span class="token punctuation">(</span><span class="token plain">i </span><span class="token operator">*</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">i</span><span class="token punctuation">,</span><span class="token plain"> j</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">=&gt;</span><span class="token plain"> UIO</span><span class="token punctuation">(</span><span class="token plain">i </span><span class="token operator">+</span><span class="token plain"> j</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="transforming-the-input-of-the-output-http">Transforming the Input of the output <code>Http</code><a class="hash-link" href="#transforming-the-input-of-the-output-http" title="Direct link to heading">​</a></h3><p>We can use <code>contramap</code> or <code>contramapZIO</code> for transforming the input type of the output <code>Http</code></p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> middleware</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">codec</span><span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token plain">decoder </span><span class="token operator">=</span><span class="token plain"> a </span><span class="token keyword">=&gt;</span><span class="token plain"> Right</span><span class="token punctuation">(</span><span class="token plain">a </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> encoder </span><span class="token operator">=</span><span class="token plain"> b </span><span class="token keyword">=&gt;</span><span class="token plain"> Right</span><span class="token punctuation">(</span><span class="token plain">b </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">val</span><span class="token plain"> mid1</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> middleware</span><span class="token punctuation">.</span><span class="token plain">contramap</span><span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token plain">_</span><span class="token punctuation">.</span><span class="token plain">toInt</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">val</span><span class="token plain"> mid2</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> middleware</span><span class="token punctuation">.</span><span class="token plain">contramapZIO</span><span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token plain">a </span><span class="token keyword">=&gt;</span><span class="token plain"> UIO</span><span class="token punctuation">(</span><span class="token plain">a</span><span class="token punctuation">.</span><span class="token plain">toInt</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conditional-application-of-middlewares">Conditional application of middlewares<a class="hash-link" href="#conditional-application-of-middlewares" title="Direct link to heading">​</a></h2><ul><li><code>when</code> applies middleware only if the condition function evaluates to true</li></ul><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> middleware</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">succeed</span><span class="token punctuation">(</span><span class="token string">&quot;yes&quot;</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">val</span><span class="token plain"> mid</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> middleware</span><span class="token punctuation">.</span><span class="token plain">when</span><span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">str</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">=&gt;</span><span class="token plain"> str</span><span class="token punctuation">.</span><span class="token plain">length </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>-<code>whenZIO</code> applies middleware only if the condition function(with effect) evaluates</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> middleware</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">succeed</span><span class="token punctuation">(</span><span class="token string">&quot;yes&quot;</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain"></span><span class="token keyword">val</span><span class="token plain"> mid</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> middleware</span><span class="token punctuation">.</span><span class="token plain">whenZIO</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">str</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">=&gt;</span><span class="token plain"> UIO</span><span class="token punctuation">(</span><span class="token plain">str</span><span class="token punctuation">.</span><span class="token plain">length </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Logical operators to decide which middleware to select based on the predicate:</p><ul><li>Using <code>ifThenElse</code> </li></ul><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> mid</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">ifThenElse</span><span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token plain">_ </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    isTrue </span><span class="token operator">=</span><span class="token plain"> i </span><span class="token keyword">=&gt;</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">succeed</span><span class="token punctuation">(</span><span class="token plain">i </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    isFalse </span><span class="token operator">=</span><span class="token plain"> i </span><span class="token keyword">=&gt;</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">succeed</span><span class="token punctuation">(</span><span class="token plain">i </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Using <code>ifThenElseZIO</code> </li></ul><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token keyword">val</span><span class="token plain"> mid</span><span class="token operator">:</span><span class="token plain"> Middleware</span><span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">ifThenElseZIO</span><span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token plain">i </span><span class="token keyword">=&gt;</span><span class="token plain"> UIO</span><span class="token punctuation">(</span><span class="token plain">i </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    isTrue </span><span class="token operator">=</span><span class="token plain"> i </span><span class="token keyword">=&gt;</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">succeed</span><span class="token punctuation">(</span><span class="token plain">i </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    isFalse </span><span class="token operator">=</span><span class="token plain"> i </span><span class="token keyword">=&gt;</span><span class="token plain"> Middleware</span><span class="token punctuation">.</span><span class="token plain">succeed</span><span class="token punctuation">(</span><span class="token plain">i </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-complete-example-of-a-middleware">A complete example of a middleware<a class="hash-link" href="#a-complete-example-of-a-middleware" title="Direct link to heading">​</a></h2><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary><b>Detailed example showing &quot;debug&quot; and &quot;addHeader&quot; middlewares</b></summary><div><div class="collapsibleContent_i85q"><div class="language-scala codeBlockContainer_Ckt0 theme-code-block"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line"><span class="token plain">    </span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token namespace">http</span><span class="token namespace punctuation">.</span><span class="token plain">_</span><br></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token namespace">http</span><span class="token namespace punctuation">.</span><span class="token namespace">middleware</span><span class="token namespace punctuation">.</span><span class="token plain">HttpMiddleware</span><br></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token namespace">http</span><span class="token namespace punctuation">.</span><span class="token plain">Server</span><br></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token namespace">clock</span><span class="token namespace punctuation">.</span><span class="token punctuation">{</span><span class="token plain">Clock</span><span class="token punctuation">,</span><span class="token plain"> currentTime</span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token namespace">console</span><span class="token namespace punctuation">.</span><span class="token plain">Console</span><br></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token namespace">duration</span><span class="token namespace punctuation">.</span><span class="token plain">_</span><br></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">zio</span><span class="token namespace punctuation">.</span><span class="token punctuation">{</span><span class="token plain">App</span><span class="token punctuation">,</span><span class="token plain"> ExitCode</span><span class="token punctuation">,</span><span class="token plain"> URIO</span><span class="token punctuation">,</span><span class="token plain"> ZIO</span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">    </span><br></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">java</span><span class="token namespace punctuation">.</span><span class="token namespace">io</span><span class="token namespace punctuation">.</span><span class="token plain">IOException</span><br></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">import</span><span class="token plain"> </span><span class="token namespace">java</span><span class="token namespace punctuation">.</span><span class="token namespace">util</span><span class="token namespace punctuation">.</span><span class="token namespace">concurrent</span><span class="token namespace punctuation">.</span><span class="token plain">TimeUnit</span><br></span><span class="token-line"><span class="token plain">    </span><br></span><span class="token-line"><span class="token plain">     </span><span class="token keyword">val</span><span class="token plain"> app</span><span class="token operator">:</span><span class="token plain"> HttpApp</span><span class="token punctuation">[</span><span class="token plain">Clock</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token builtin">Nothing</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Http</span><span class="token punctuation">.</span><span class="token plain">collectZIO</span><span class="token punctuation">[</span><span class="token plain">Request</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">       </span><span class="token comment">// this will return result instantly</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">       </span><span class="token keyword">case</span><span class="token plain"> Method</span><span class="token punctuation">.</span><span class="token plain">GET </span><span class="token operator">-&gt;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token operator">!</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token string">&quot;text&quot;</span><span class="token plain">         </span><span class="token keyword">=&gt;</span><span class="token plain"> ZIO</span><span class="token punctuation">.</span><span class="token plain">succeed</span><span class="token punctuation">(</span><span class="token plain">Response</span><span class="token punctuation">.</span><span class="token plain">text</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">       </span><span class="token comment">// this will return result after 5 seconds, so with 3 seconds timeout it will fail</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">       </span><span class="token keyword">case</span><span class="token plain"> Method</span><span class="token punctuation">.</span><span class="token plain">GET </span><span class="token operator">-&gt;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token operator">!</span><span class="token plain"> </span><span class="token operator">/</span><span class="token plain"> </span><span class="token string">&quot;long-running&quot;</span><span class="token plain"> </span><span class="token keyword">=&gt;</span><span class="token plain"> ZIO</span><span class="token punctuation">.</span><span class="token plain">succeed</span><span class="token punctuation">(</span><span class="token plain">Response</span><span class="token punctuation">.</span><span class="token plain">text</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token plain">delay</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token plain"> seconds</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">     </span><span class="token punctuation">}</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">    </span><span class="token keyword">val</span><span class="token plain"> middlewares</span><span class="token operator">:</span><span class="token plain"> HttpMiddleware</span><span class="token punctuation">[</span><span class="token plain">Console </span><span class="token keyword">with</span><span class="token plain"> Clock</span><span class="token punctuation">,</span><span class="token plain"> IOException</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">       </span><span class="token comment">// print debug info about request and response</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">       Middleware</span><span class="token punctuation">.</span><span class="token plain">debug </span><span class="token operator">++</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">       </span><span class="token comment">// add static header</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">       Middleware</span><span class="token punctuation">.</span><span class="token plain">addHeader</span><span class="token punctuation">(</span><span class="token string">&quot;X-Environment&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;Dev&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">++</span><span class="token plain">   </span><br></span><span class="token-line"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line"><span class="token plain">   </span><span class="token keyword">override</span><span class="token plain"> </span><span class="token keyword">def</span><span class="token plain"> run</span><span class="token punctuation">(</span><span class="token plain">args</span><span class="token operator">:</span><span class="token plain"> List</span><span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> URIO</span><span class="token punctuation">[</span><span class="token plain">zio</span><span class="token punctuation">.</span><span class="token plain">ZEnv</span><span class="token punctuation">,</span><span class="token plain"> ExitCode</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line"><span class="token plain">       Server</span><span class="token punctuation">.</span><span class="token plain">start</span><span class="token punctuation">(</span><span class="token number">8090</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">app @@ middlewares</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token plain">exitCode</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-few-out-of-the-box-middlewares">A few &quot;Out of the box&quot; middlewares<a class="hash-link" href="#a-few-out-of-the-box-middlewares" title="Direct link to heading">​</a></h3><ul><li><a href="https://zio.github.io/zio-http/docs/v1.x/examples/advanced-examples/middleware_basic_auth" target="_blank" rel="noopener noreferrer">Basic Auth</a> </li><li><a href="https://zio.github.io/zio-http/docs/v1.x/examples/advanced-examples/middleware_cors" target="_blank" rel="noopener noreferrer">CORS</a></li><li><a href="https://zio.github.io/zio-http/docs/v1.x/examples/advanced-examples/middleware_csrf" target="_blank" rel="noopener noreferrer">CSRF</a></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/zio-http/v1.x/dsl/cookies"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Cookie</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zio-http/v1.x/dsl/socket/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Socket</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-a-middleware" class="table-of-contents__link toc-highlight">What is a &quot;Middleware&quot;?</a></li><li><a href="#need-for-middlewares-and-handling-aspects" class="table-of-contents__link toc-highlight">Need for middlewares and handling &quot;aspects&quot;</a></li><li><a href="#middleware-in-zio-http" class="table-of-contents__link toc-highlight">Middleware in zio-http</a><ul><li><a href="#advanced-example-showing-the-transformative-power-of-a-middleware-optional" class="table-of-contents__link toc-highlight">Advanced example showing the transformative power of a middleware (Optional)</a></li></ul></li><li><a href="#creating-middleware" class="table-of-contents__link toc-highlight">Creating Middleware</a></li><li><a href="#combining-middlewares" class="table-of-contents__link toc-highlight">Combining middlewares</a><ul><li><a href="#using--combinator" class="table-of-contents__link toc-highlight">Using <code>++</code> combinator</a></li><li><a href="#using-" class="table-of-contents__link toc-highlight">Using <code>&gt;&gt;&gt;</code></a></li><li><a href="#using--combinator-1" class="table-of-contents__link toc-highlight">Using <code>&lt;&gt;</code> combinator</a></li></ul></li><li><a href="#transforming-middlewares-some-advanced-examples" class="table-of-contents__link toc-highlight">Transforming Middlewares (some advanced examples)</a><ul><li><a href="#transforming-the-output-of-the-output-http" class="table-of-contents__link toc-highlight">Transforming the output of the output <code>Http</code></a></li><li><a href="#transforming-the-input-of-the-output-http" class="table-of-contents__link toc-highlight">Transforming the Input of the output <code>Http</code></a></li></ul></li><li><a href="#conditional-application-of-middlewares" class="table-of-contents__link toc-highlight">Conditional application of middlewares</a></li><li><a href="#a-complete-example-of-a-middleware" class="table-of-contents__link toc-highlight">A complete example of a middleware</a><ul><li><a href="#a-few-out-of-the-box-middlewares" class="table-of-contents__link toc-highlight">A few &quot;Out of the box&quot; middlewares</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item">
                <img src="/img/navbar_brand.png" alt="zio">
            </li></ul></div><div class="col footer__col"><div class="footer__title">Github</div><ul class="footer__items clean-list"><li class="footer__item">
              <a href="https://github.com/zio/zio">
                <img src="https://img.shields.io/github/stars/zio/zio?style=social" alt="github">
              </a>
            </li></ul></div><div class="col footer__col"><div class="footer__title">Chat with us on Discord</div><ul class="footer__items clean-list"><li class="footer__item">
                <a href="https://discord.gg/2ccFBr4">
                  <img src="https://img.shields.io/discord/629491597070827530?logo=discord&style=social" alt="discord">
                </a>
              </li></ul></div><div class="col footer__col"><div class="footer__title">Follow us on Twitter</div><ul class="footer__items clean-list"><li class="footer__item">
                <a href="https://twitter.com/zioscala">
                  <img src="https://img.shields.io/twitter/follow/zioscala?label=Follow&style=social" alt="twitter">
                </a>
              </li></ul></div><div class="col footer__col"><div class="footer__title">Additional resources</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://javadoc.io/doc/dev.zio/zio_2.12/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Scaladoc of ZIO<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 ZIO Maintainers - Built with <a href="https://v2.docusaurus.io/">Docusaurus v2</a></div></div></div></footer></div>
<script src="/assets/js/runtime~main.45d048c3.js"></script>
<script src="/assets/js/main.c278ee17.js"></script>
</body>
</html>